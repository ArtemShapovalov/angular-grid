!function(e,t){"function"==typeof define&&define.amd?define(["angular","jsonary","angular-bootstrap","bootstrap-decorator","lodash"],t):"object"==typeof exports?module.exports=t(require("angular"),require("Jsonary"),require("angularBootstrap"),require("bootstrapDecorator"),require("lodash")):e.grid=t(e.angular,e.Jsonary,e.angularBootstrap,e.bootstrapDecorator,e.lodash)}(this,function(e,t,r,n,o){function a(e){function r(e,r){function a(e){n=e}function i(e){o=e}function s(e){M=e}function c(){return M}function l(e){return F[e]}function u(e,t){F[e]=t}function d(e,r){var n=this;return void 0===M?(alert("Please set model before call fetch data"),!1):void t.getData(e,function(e){var t=e,o=e.property("data").schemas()[0].data.document.raw.value();n.setData(t),n.setSchema(o),void 0!==r&&r(t,o)})}function f(e,r){var n=this;t.getSchema(e,function(e){var o=e.data.document.raw.value(),a=t.create(p(e.data.value(),o));a.document.url=n.getModel().url,a.addSchema(e),n.setData(a),n.setSchema(o),void 0!==r&&r(a,o)})}function p(e,t){function n(e){var t=e;return r.forEach(t,function(e,r){if(e.type)switch(e.type){case"object":t[r]={};break;case"string":t[r]="";break;case"array":t[r]=[];break;case"integer":t[r]=""}}),t}var o,a=v(e,t);return o=r.clone(a.properties),o.data=n(r.clone(a.properties.data.properties)),o.data.attributes=n(r.clone(a.properties.data.properties.attributes.properties)),o}function m(t){function r(e,r){var o=v(e.schemas()[0].data.value(),r);n.type=n.TYPE_TABLE,n.config.table||(n.config.table={}),n.config.table.rows=b(k(e)),n.config.table.links=e.links(),n.config.table.columns=y(o),n.config.table.columns.push({title:"Actions",type:"string",attributeName:"links"}),void 0!==t&&t(n.config.table)}var n=this,o=n.getModel();e(function(){n.fetchData(o.url,r)})}function g(t){function n(e,n){var a=e.property("data").property("attributes"),i=v(a.schemas()[0].data.value(),n);o.type=o.TYPE_FORM,o.config.form||(o.config.form={}),o.config.form.links=e.links(),o.config.form.schema=i,o.config.form.model=a.value(),o.config.form.form=["*"],o.config.form.form=r.union(o.config.form.form,$(e.property("data").links())),void 0!==t&&t(o.config.form)}var o=this,a=o.getModel(),i=a.url;"update"===a.params.type||"read"===a.params.type?(i=a.url+"/"+a.params.type+"/"+a.params.id,e(function(){o.fetchData(i,n)})):"create"===a.params.type&&(i=a.url+"/schema#/definitions/create",e(function(){o.fetchSchema(i,n)}))}function h(e,t){for(var r in e)e.hasOwnProperty(r)&&("object"==typeof e[r]&&!Array.isArray(e[r])&&e[r].$ref&&(e[r]=Object.byString(t,e[r].$ref.substring(2)),h(e[r],t)),"object"!=typeof e[r]||Array.isArray(e[r])||"links"===e[r]||h(e[r],t));return e}function v(e,t){var r=e;return r=h(r,t)}function y(e){var t=e.properties.data.items.properties.attributes.properties,n=[];return r.forEach(t,function(e,t){e.attributeName=t,n.push(e)}),n}function b(e){var t=[];return e.forEach(function(e){var n=e.property("attributes").value();n.links=[],r.forOwn(e.links(),function(e){n.links.push(e)}),t.push(n)}),t}function k(e){var t=[];return e.property("data").items(function(e,r){t.push(r)}),t}function $(e){var t=[];return r.forEach(e,function(e){t.push({type:"button",title:e.title,link:e,onClick:"edit($event, form)"})}),t}var M,F={successDeleted:"You successfully delete this resource",successCreated:"You successfully create new resource",successUpdated:"You successfully update this resource",serverError:"Oops! server error"};return{TYPE_FORM:"form",TYPE_TABLE:"table",type:"",config:{},setData:a,setModel:s,getModel:c,setSchema:i,getMessage:l,setMessage:u,fetchData:d,fetchSchema:f,getTableInfo:m,getFormInfo:g}}var n,o,a={$get:r};return r.$inject=["$timeout","_"],a}function i(e){return function(t){var r=t.definition.data.propertyValue("href"),n=r.replace(/{([^\{,}]*)}/g,function(e,r){return t.subjectData.propertyValue(r)});e.url(n)}}function s(e,t){return function(r,n){function o(){t.type===t.TYPE_TABLE?t.getTableInfo(function(e){n.rows=e.rows,n.columns=e.columns,n.links=e.links}):t.type===t.TYPE_FORM&&(n.hideForm=!0),n.alerts.push({type:"success",msg:t.getMessage("successDeleted")})}function a(e){n.alerts.push({type:"danger",msg:e.statusText||t.getMessage("serverError")})}var i={method:r.method,url:r.href};e(i).then(o,a)}}function c(e,t){return function(r,n){function o(){t.getFormInfo(function(e){n.schema=e.schema,n.form=e.form,n.model=e.model,n.alerts.push({type:"success",msg:t.getMessage("successUpdated")})})}function a(e){n.alerts.push({type:"danger",msg:e.statusText||t.getMessage("serverError")})}var i={method:r.method,url:r.href,data:n.model};return n.$broadcast("schemaFormValidate"),n.scopeForm.gridForm.$valid?void e(i).then(o,a):!1}}function l(e,t){return function(r,n){function o(){t.getFormInfo(function(e){n.schema=e.schema,n.form=e.form,n.model=e.model,n.alerts.push({type:"success",msg:t.getMessage("successCreated")})})}function a(e){n.alerts.push({type:"danger",msg:e.statusText||t.getMessage("serverError")})}var i={method:r.method,url:r.href,data:n.model};return n.$broadcast("schemaFormValidate"),n.scopeForm.gridForm.$valid?void e(i).then(o,a):!1}}function u(){function e(e,t,r,n){return this.actions={goToUpdate:e,goToCreate:e,goToList:e,read:e,"delete":t,update:r,create:n},{action:function(e,t){this.actions[e.definition.data.propertyValue("rel")](e,t)}.bind(this)}}var t={actions:{},$get:e};return e.$inject=["grid-action-goTo","grid-action-delete","grid-action-update","grid-action-create"],t}function d(){function e(e,t,r){e.alerts=[],e.scopeForm={gridForm:{}},e.setFormScope=function(t){e.scopeForm=t},t.setModel(e.gridModel),t.getFormInfo(function(t){e.schema=t.schema,e.form=t.form,e.model=t.model,e.links=t.links,e.$digest()}),e.edit=function(t,n){r.action(n.link,e)},e.go=function(t){r.action(t,e)},e.closeAlert=function(t){e.alerts.splice(t,1)}}var t={restrict:"EA",scope:{gridModel:"=gridModel"},replace:!0,templateUrl:"templates/grid/form.html",controller:e};return e.$inject=["$scope","grid-entity","grid-actions"],t}var f=e.module("grid",["schemaForm","ui.bootstrap.tpls"]);return f.run(["$templateCache",function(e){e.put("templates/grid/table.html",'<span ng-repeat="link in links"><a href="javascript:void(0);" ng-click="edit(link)">{{link.title}}</a> </span><div><alert ng-repeat="alert in alerts" type="{{alert.type}}" close="closeAlert($index)">{{alert.msg}}</alert></div><table class="table grid"><thead><tr><th ng-repeat="column in columns">{{column.title}}</th></tr></thead><tbody><tr ng-repeat="row in rows"><td ng-repeat="column in columns"><span ng-if="column.attributeName !== \'links\'">{{row[column.attributeName]}}</span><span ng-if="column.attributeName == \'links\'"><span ng-repeat="link in row.links"><a href="javascript:void(0);" ng-click="edit(link)">{{link.title}}</a> </span></span></td></tr></tbody></table>'),e.put("templates/grid/form.html",'<div><span ng-repeat="link in links"><a href="javascript:void(0);" ng-click="go(link)">{{link.title}}</a> </span><div><alert ng-repeat="alert in alerts" type="{{alert.type}}" close="closeAlert($index)">{{alert.msg}}</alert></div><form novalidate name="gridForm" ng-init="setFormScope(this)"sf-schema="schema" sf-form="form" sf-model="model"class="form-horizontal" role="form" ng-if="hideForm !== true"></form></div>')}]),f.factory("_",function(){return o}),f.provider("grid-entity",a),a.$inject=[],f.factory("grid-action-goTo",i),i.$inject=["$location"],f.factory("grid-action-delete",s),s.$inject=["$http","grid-entity"],f.factory("grid-action-update",c),c.$inject=["$http","grid-entity"],f.factory("grid-action-create",l),l.$inject=["$http","grid-entity"],f.provider("grid-actions",u),u.$inject=[],f.directive("gridForm",d),d.$inject=[],f.directive("gridTable",["$timeout","grid-entity","grid-actions",function(e,t,r){return{restrict:"E",templateUrl:"templates/grid/table.html",scope:{gridModel:"=gridModel"},controller:function(e){e.alerts=[],t.setModel(e.gridModel),t.getTableInfo(function(t){e.rows=t.rows,e.columns=t.columns,e.links=t.links,e.$digest()}),e.edit=function(t){r.action(t,e)},e.closeAlert=function(t){e.alerts.splice(t,1)}},link:function(e,t,r,n){}}}]),Object.byString=function(e,t){t=t.replace(/\[(\w+)]/g,".$1"),t=t.replace(/\/(\w+)/g,".$1"),t=t.replace(/^\./,"");for(var r=t.split("."),n=0,o=r.length;o>n;++n){var a=r[n];if(!(a in e))return;e=e[a]}return e},grid});