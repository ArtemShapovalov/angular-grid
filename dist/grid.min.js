!function(t,e){"function"==typeof define&&define.amd?define(["angular","jsonary","angular-bootstrap","bootstrap-decorator","lodash"],e):"object"==typeof exports?module.exports=e(require("angular"),require("Jsonary"),require("angularBootstrap"),require("bootstrapDecorator"),require("lodash")):t.vmsGrid=e(t.angular,t.Jsonary,t.angularBootstrap,t.bootstrapDecorator,t._)}(this,function(t,e,r,n,o){function a(){function t(t,o){function a(t){r=t}function i(t){n=t}function c(t){D=t}function s(){return D}function u(t){return S[t]}function l(t,e){S[t]=e}function d(t,e){function r(t,r){n.setData(t),n.setSchema(r),void 0!==e&&e(t,r)}var n=this;"create"===D.params.type?n.loadSchema(t,r):n.loadData(t,r)}function f(t,r){return void 0===D?(alert("Please set model before call fetch data"),!1):void e.getData(t,function(t,e){var n=t,o=t.property("data").schemas()[0].data.document.raw.value();void 0!==r&&r(n,o,e)})}function p(t,r){var n=this;e.getSchema(t,function(t){var o=t.data.document.raw.value(),a=e.create(m(t.data.value(),o));a.document.url=n.getModel().url,a.addSchema(t),void 0!==r&&r(a,o)})}function m(t,e){function r(t){var e=t;return o.forEach(e,function(t,r){if(t.type)switch(t.type){case"object":e[r]={};break;case"string":e[r]="";break;case"array":e[r]=[];break;case"integer":e[r]=""}}),e}var n,a=k(t,e);return n=o.clone(a.properties),n.data=r(o.clone(a.properties.data.properties)),n.data.attributes=r(o.clone(a.properties.data.properties.attributes.properties)),n}function g(t,e){var r=t;return e.resource&&(r=t+"/"+e.resource),e.type&&("update"===e.type||"read"===e.type?r+="/"+e.type+"/"+e.id:"create"===e.type&&(r+="/schema#/definitions/create")),r}function h(e){function r(t,r){var n=k(t.schemas()[0].data.value(),r);o.type=o.TYPE_TABLE,o.config.table||(o.config.table={}),j(t,function(r,a){o.config.table.rows=F(r),o.config.table.links=t.links(),o.config.table.columns=$(n),o.config.table.columns.push({title:"Actions",type:"string",attributeName:"links"}),void 0!==e&&e(o.config.table)})}var n,o=this,a=o.getModel();n=g(a.url,a.params),t(function(){o.fetchData(n,r)})}function y(e){function r(t,r){var n=t.property("data").property("attributes"),i=k(n.schemas()[0].data.value(),r);a.type=a.TYPE_FORM,a.config.form||(a.config.form={}),v(t,function(r,n){a.config.form.links=t.links(),a.config.form.schema=i,a.config.form.model=E(r),a.config.form.form=["*"],a.config.form.form=o.union(a.config.form.form,A(t.property("data").links())),void 0!==e&&e(a.config.form)})}var n,a=this,i=a.getModel();n=g(i.url,i.params),t(function(){a.fetchData(n,r)})}function v(t,e){function r(t){var r={own:n,relationships:o.mapValues(t[0],function(t){return o.forEach(t,function(e,r){t[r]=e.data}),t})};e(r)}var n,a=[];n=t.property("data"),a.push(T(t.property("data"))),M(a,r)}function b(t,e){for(var r in t)t.hasOwnProperty(r)&&("object"==typeof t[r]&&!Array.isArray(t[r])&&t[r].$ref&&(t[r]=Object.byString(e,t[r].$ref.substring(2)),b(t[r],e)),"object"!=typeof t[r]||Array.isArray(t[r])||"links"===t[r]||b(t[r],e));return t}function k(t,e){var r=t;return r=b(r,e)}function $(t){var e=[],r=t.properties.data.items.properties.attributes.properties;return o.forEach(r,function(t,r){t.attributeName=r,e.push(t)}),e}function E(t){var e=t.own,r=e.property("attributes").value();return o.forEach(t.relationships,function(t,n){r[n]=o.map(t,function(t){return t.property("data").propertyValue("id")}),Array.isArray(e.property("relationships").property(n).propertyValue("data"))||(r[n]=r[n][0])}),r}function F(t){var e=[];return o.forEach(t,function(t){var r=t.own,n=r.property("attributes").value();o.forEach(t.relationships,function(e,r){n[r]=o.map(e,function(e){var n=t.own.property("relationships").property(r).schemas()[0].data.propertyValue("name");return n?e.property("data").property("attributes").propertyValue(n):e.property("data").propertyValue("id")}).join(", ")}),n.links=[],o.forOwn(r.links(),function(t){n.links.push(t)}),e.push(n)}),e}function j(t,e){function r(t){var r=[];o.forEach(n,function(e,n){var a={own:e,relationships:o.mapValues(t[n],function(t){return o.forEach(t,function(e,r){t[r]=e.data}),t})};r.push(a)}),e(r)}var n=[],a=[];t.property("data").items(function(t,e){a.push(T(e)),n.push(e)}),M(a,r)}function T(t){var e,r={};return(e=t.property("relationships").value())&&o.forEach(e,function(t,e){r[e]=w(t)}),r}function w(t){var e=[];if(Array.isArray(t.data)){var r=[];o.forEach(t.data,function(e){r.push({url:g(t.links.self,{type:"read",id:e.id})})}),e=r}else e=[{url:g(t.links.self,{type:"read",id:t.data.id})}];return e}function M(t,e){function r(t,e,r){a[t.document.url]={data:t,schema:e},console.log("load")}var n=[],a={},i={},c=0,s=0;o.forEach(t,function(t){o.forEach(t,function(t){o.forEach(t,function(t){i[t.url]?(console.log("cache"),c++):(f(t.url,r),i[t.url]={},c++,s++)})})});var u=setInterval(function(){o.size(a)===s&&(clearInterval(u),o.forEach(t,function(t,e){o.forEach(t,function(t,r){o.forEach(t,function(t,o){n[e]=n[e]||{},n[e][r]=n[e][r]||[],n[e][r][o]=a[t.url]})})}),e(n))},100)}function A(t){var e=[];return o.forEach(t,function(t){e.push({type:"button",title:t.title,link:t,onClick:"edit($event, form)"})}),e}var D,S={successDeleted:"Successfully delete",successCreated:"Successfully create",successUpdated:"Successfully update",serverError:"Oops! server error"};return{TYPE_FORM:"form",TYPE_TABLE:"table",type:"",config:{},setData:a,setModel:c,getModel:s,setSchema:i,getMessage:u,setMessage:l,fetchData:d,loadData:f,loadSchema:p,getTableInfo:h,getFormInfo:y}}var r,n,o={$get:t};return t.$inject=["$timeout","_"],o}function i(t,e){return function(r,n){function o(){e.getFormInfo(function(t){n.schema=t.schema,n.form=t.form,n.model=t.model,n.alerts.push({type:"success",msg:e.getMessage("successCreated")})})}function a(t){n.alerts.push({type:"danger",msg:t.statusText||e.getMessage("serverError")})}var i={method:r.method,url:r.href,data:n.model};return n.$broadcast("schemaFormValidate"),n.scopeForm.gridForm.$valid?void t(i).then(o,a):!1}}function c(t,e){return function(r,n){function o(){e.type===e.TYPE_TABLE?e.getTableInfo(function(t){n.rows=t.rows,n.columns=t.columns,n.links=t.links}):e.type===e.TYPE_FORM&&(n.hideForm=!0),n.alerts.push({type:"success",msg:e.getMessage("successDeleted")})}function a(t){n.alerts.push({type:"danger",msg:t.statusText||e.getMessage("serverError")})}var i={method:r.method,url:r.href};t(i).then(o,a)}}function s(t){return function(e){var r=e.definition.data.propertyValue("href"),n=r.replace(/{([^\{,}]*)}/g,function(t,r){return e.subjectData.propertyValue(r)});t.url(n)}}function u(){function t(t,e,r,n){return this.actions={goToUpdate:t,goToCreate:t,goToList:t,read:t,"delete":e,update:r,create:n},{action:function(t,e){this.actions[t.definition.data.propertyValue("rel")](t,e)}.bind(this)}}var e={actions:{},$get:t};return t.$inject=["grid-action-goTo","grid-action-delete","grid-action-update","grid-action-create"],e}function l(t,e){return function(r,n){function o(){e.getFormInfo(function(t){n.schema=t.schema,n.form=t.form,n.model=t.model,n.alerts.push({type:"success",msg:e.getMessage("successUpdated")})})}function a(t){n.alerts.push({type:"danger",msg:t.statusText||e.getMessage("serverError")})}var i={method:r.method,url:r.href,data:n.model};return n.$broadcast("schemaFormValidate"),n.scopeForm.gridForm.$valid?void t(i).then(o,a):!1}}function d(){function t(t,e,r){t.alerts=[],t.scopeForm={gridForm:{}},t.setFormScope=function(e){t.scopeForm=e},e.getFormInfo(function(e){t.schema=e.schema,t.form=e.form,t.model=e.model,t.links=e.links,t.$digest()}),t.edit=function(e,n){r.action(n.link,t)},t.go=function(e){r.action(e,t)},t.closeAlert=function(e){t.alerts.splice(e,1)}}var e={restrict:"E",replace:!0,controller:t};return t.$inject=["$scope","grid-entity","grid-actions"],e}function f(t,e){function r(r){r.alerts=[],t.getTableInfo(function(t){r.rows=t.rows,r.columns=t.columns,r.links=t.links,r.$digest()}),r.edit=function(t){e.action(t,r)},r.closeAlert=function(t){r.alerts.splice(t,1)}}var n={restrict:"E",controller:r};return r.$inject=["$scope"],n}function p(){function t(t,e){t.getTemplateUrl=function(){return t.gridModel.params.type?"templates/grid/form.html":"templates/grid/table.html"},e.setModel(t.gridModel)}var e={restrict:"E",template:'<ng-include src="getTemplateUrl()" />',scope:{gridModel:"=gridModel"},controller:t,link:function(t,e,r,n){}};return t.$inject=["$scope","grid-entity"],e}var m=[];try{t.module("schemaForm"),m.push("schemaForm")}catch(g){}try{t.module("ui.bootstrap"),m.push("ui.bootstrap")}catch(g){}var h=t.module("grid",m);return t.module("grid").run(["$templateCache",function(t){t.put("templates/grid/table.html",'<grid-table><span ng-repeat="link in links"><a href="javascript:void(0);" ng-click="edit(link)">{{link.title}}</a> </span><alert ng-repeat="alert in alerts" type="{{alert.type}}" close="closeAlert($index)">{{alert.msg}}</alert><table class="table grid"><thead><tr><th ng-repeat="column in columns">{{column.title}}</th></tr></thead><tbody><tr ng-repeat="row in rows"><td ng-repeat="column in columns"><span ng-if="column.attributeName !== \'links\'">{{row[column.attributeName]}}</span><span ng-if="column.attributeName == \'links\'"><span ng-repeat="link in row.links"><a href="javascript:void(0);" ng-click="edit(link)">{{link.title}}</a> </span></span></td></tr></tbody></table></grid-table>'),t.put("templates/grid/form.html",'<grid-form><span ng-repeat="link in links"><a href="javascript:void(0);" ng-click="go(link)">{{link.title}}</a> </span><div><alert ng-repeat="alert in alerts" type="{{alert.type}}" close="closeAlert($index)">{{alert.msg}}</alert></div><form novalidate name="gridForm" ng-init="setFormScope(this)"sf-schema="schema" sf-form="form" sf-model="model"class="form-horizontal" role="form" ng-if="hideForm !== true"></form></grid-form>')}]),t.module("grid").factory("_",function(){return o}),t.module("grid").provider("grid-entity",a),Object.byString=function(t,e){e=e.replace(/\[(\w+)]/g,".$1"),e=e.replace(/\/(\w+)/g,".$1"),e=e.replace(/^\./,"");for(var r=e.split("."),n=0,o=r.length;o>n;++n){var a=r[n];if(!(a in t))return;t=t[a]}return t},t.module("grid").factory("grid-action-create",i),i.$inject=["$http","grid-entity"],t.module("grid").factory("grid-action-delete",c),c.$inject=["$http","grid-entity"],t.module("grid").factory("grid-action-goTo",s),s.$inject=["$location"],t.module("grid").provider("grid-actions",u),u.$inject=[],t.module("grid").factory("grid-action-update",l),l.$inject=["$http","grid-entity"],t.module("grid").directive("gridForm",d),t.module("grid").directive("gridTable",f),f.$inject=["grid-entity","grid-actions"],t.module("grid").directive("vmsGrid",p),h});