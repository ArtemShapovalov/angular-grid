!function(t,e){"function"==typeof define&&define.amd?define(["angular","jsonary","angular-bootstrap","bootstrap-decorator","lodash"],e):"object"==typeof exports?module.exports=e(require("angular"),require("Jsonary"),require("angularBootstrap"),require("bootstrapDecorator"),require("lodash")):t.vmsGrid=e(t.angular,t.Jsonary,t.angularBootstrap,t.bootstrapDecorator,t._)}(this,function(t,e,r,a,n){function o(e,r,a,n){function o(){this.form=[],this.model={},this.schema={},this.links={}}function i(){var t=this;return{form:t.form,model:t.model,schema:t.schema,links:t.links}}function s(t){function e(e,r){var a=e.property("data").property("attributes"),i=o.mergeRelSchema(a.schemas()[0].data.value(),r);o.type=o.TYPE_FORM,o._getFieldsForm(e,function(r,a){function s(r){o.form=r,o.form=n.union(o.form,o._getFormButtonBySchema(e.property("data").links())),void 0!==t&&t(o.getConfig())}o.links=e.links(),o.schema=i,o.model=o._fieldsToFormFormat(r),o._getFormConfig(e,s)})}var a,o=this,i=o.getModel();a=o.getResourceUrl(i.url,i.params),r(function(){o.fetchData(a,e)})}function c(t){var e=t.own,r=e.property("attributes").value();return n.forEach(t.relationships,function(t,a){r[a]=n.map(t,function(t){return t.property("data").propertyValue("id")}),Array.isArray(e.property("relationships").property(a).propertyValue("data"))||(r[a]=r[a][0])}),r}function u(t,e){var a=this,o=[];a._createTitleMap(t.property("data"),function(i){var s=a.mergeRelSchema(t.property("data").schemas()[0].data.value(),t.schemas()[0].data.document.raw.value()).properties.attributes.properties;n.forEach(s,function(t,e){var r={key:e};i[e]&&(r.titleMap=i[e]),o.push(r)}),r(function(){e(o)})})}function l(t,e){function r(t){var r={own:a,relationships:n.mapValues(t[0],function(t){return n.forEach(t,function(e,r){t[r]=e.data}),t})};e(r)}var a,o=this,i=[];a=t.property("data"),i.push(o._getRelationResource(t.property("data"))),o._batchLoadData(i,r)}function p(t){var e=this,r=[],a=t.property("relationships"),o=t.property("attributes"),i=a.value(),s=(o.value(),t.schemas()[0].data.document.raw.value());return n.forEach(i,function(t,i){var c=t.links.self,u=a.property(i).schemas()[0].data.propertyValue("name"),l=e._replaceFromFull(o.schemas()[0].data.value(),s).properties[i],p={};l.items&&l.items["enum"]?p=l.items["enum"]:l["enum"]&&(p=l["enum"]),n.forEach(p,function(t){var a=e.getResourceUrl(c,{type:e["default"].actionGetResource,id:t});r.push({url:a,enumItem:t,relationName:i,attributeName:u})})}),r}function d(t,e){var r=this,a=r._getTitleMapsForRelations(t);r.fetchCollection(n.map(a,"url"),function(t){var r={};n.forEach(a,function(e){r[e.relationName]||(r[e.relationName]=[]),r[e.relationName].push({value:e.enumItem,name:t[e.url].data.property("data").property("attributes").propertyValue(e.attributeName)||e.enumItem})}),e(r)})}function f(t,e){function r(t){var e=t;return n.forEach(e,function(t,r){if(t.type)switch(t.type){case"object":e[r]={};break;case"string":e[r]="";break;case"array":e[r]=[];break;case"integer":e[r]=""}}),e}var a,o=this,i=o.mergeRelSchema(t,e);return a=n.clone(i.properties),a.data=r(n.clone(i.properties.data.properties)),a.data.attributes=r(n.clone(i.properties.data.properties.attributes.properties)),a}function m(t){var e=[];return n.forEach(t,function(t){e.push({type:"button",title:t.title,link:t,onClick:"edit($event, form)"})}),e}return t.extend(o.prototype,{getFormInfo:s,getConfig:i,_getTitleMapsForRelations:p,_createTitleMap:d,_getFormConfig:u,_getFieldsForm:l,_fieldsToFormFormat:c,_getEmptyData:f,_getFormButtonBySchema:m},e),o}function i(e){function r(){this.pageParam="page",this.currentPage=1,this.pageCount=0,this.perPage=1,this.totalCount=2}function a(){return this.pageParam}function n(t){this.totalCount=t}function o(){return this.totalCount}function i(t){this.perPage=t}function s(){return this.perPage}function c(){var t=this.perPage<1?1:Math.ceil(this.totalCount/this.perPage);return Math.max(t||0,1)}function u(t){this.currentPage=t}function l(){return this.currentPage}function p(){var t;return t=Math.max(this.currentPage||0,1)*this.perPage-this.perPage}function d(t){var e,r={},a=t.indexOf("?");e=t,a>=0&&(r=f(t),e=t.slice(0,a)),r[this.pageParam+"[offset]"]=this.getOffset(),r[this.pageParam+"[limit]"]=this.getPerPage();var n=Object.keys(r).map(function(t){return t+"="+encodeURIComponent(r[t])}).join("&");return n=n?"?"+n:"",e+n}function f(t){var r;return r=e.chain(t.slice(t.indexOf("?")+1).split("&")).map(function(t){return t?t.split("="):void 0}).compact().object().value()}return t.extend(r.prototype,{getPageParam:a,setTotalCount:n,getTotalCount:o,setPerPage:i,getPerPage:s,getPageCount:c,setCurrentPage:u,getCurrentPage:l,getOffset:p,getPageUrl:d}),r}function s(e,r,a,n){function o(){this.pagination=new r,this.rows=[],this.columns={},this.schema={},this.links={}}function i(){var t=this;return{rows:t.rows,columns:t.columns,schema:t.schema,links:t.links}}function s(t){function e(e,r){var a=n.mergeRelSchema(e.schemas()[0].data.value(),r);n.pagination.setTotalCount(e.property("meta").propertyValue("total")),n.type=n.TYPE_TABLE,n._getRowsByData(e,function(r){n.rows=n.rowsToTableFormat(r),n.links=e.links(),n.columns=n.getColumnsBySchema(a),n.columns.push({title:"Actions",type:"string",attributeName:"links"}),void 0!==t&&t(n.getConfig())})}var r,n=this,o=n.getModel();r=n.pagination.getPageUrl(n.getResourceUrl(o.url,o.params)),a(function(){n.fetchData(r,e)})}function c(t){var e=[],r=t.properties.data.items.properties.attributes.properties;return n.forEach(r,function(t,r){t.attributeName=r,e.push(t)}),e}function u(t){var e=[];return n.forEach(t,function(t){var r=t.own,a=r.property("attributes").value();n.forEach(t.relationships,function(e,r){a[r]=n.map(e,function(e){var a=t.own.property("relationships").property(r).schemas()[0].data.propertyValue("name");return a?e.property("data").property("attributes").propertyValue(a):e.property("data").propertyValue("id")}).join(", ")}),a.links=[],n.forOwn(r.links(),function(t){a.links.push(t)}),e.push(a)}),e}function l(t,e){function r(t){var r=[];n.forEach(o,function(e,a){var o={own:e,relationships:n.mapValues(t[a],function(t){return n.forEach(t,function(e,r){t[r]=e.data}),t})};r.push(o)}),e(r)}var a=this,o=[],i=[];t.property("data").items(function(t,e){i.push(a._getRelationResource(e)),o.push(e)}),a._batchLoadData(i,r)}return t.extend(o.prototype,{getConfig:i,getTableInfo:s,getColumnsBySchema:c,rowsToTableFormat:u,_getRowsByData:l},e),o}function c(){function t(t,r,a){function n(t){b=t}function o(){return b}function i(t){return k[t]}function s(t,e){k[t]=e}function c(t,e){var r=t;return e.resource&&(r=t+"/"+e.resource),e.type&&("update"===e.type||"read"===e.type?r+="/"+e.type+"/"+e.id:"create"===e.type&&(r+="/schema#/definitions/create")),r}function u(t,r){return void 0===b?(alert("Please set model before call fetch data"),!1):void e.getData(t,function(t,e){var a=t,n=t.property("data").schemas()[0].data.document.raw.value();void 0!==r&&r(a,n,e)})}function l(t,r){var a=this;e.getSchema(t,function(t){var n=t.data.document.raw.value(),o=e.create(a._getEmptyData(t.data.value(),n));o.document.url=a.getModel().url,o.addSchema(t),void 0!==r&&r(o,n)})}function p(t,e){function r(t,r){void 0!==e&&e(t,r)}var a=this;"create"===b.params.type?a.loadSchema(t,r):a.loadData(t,r)}function d(t,e){var n,o=this,i=0,s=0,c={};n=a.uniq(t),a.forEach(n,function(t){o.loadData(t,function(e,r,a){c[t]={data:e,schema:r,request:a},i++}),s++});var u=r(function(){s===i&&(r.cancel(u),void 0!==e&&e(c))},100)}function f(t,e){var r=t;return r=m(r,e)}function m(t,e){for(var r in t)t.hasOwnProperty(r)&&("object"==typeof t[r]&&!Array.isArray(t[r])&&t[r].$ref&&(t[r]=Object.byString(e,t[r].$ref.substring(2)),m(t[r],e)),"object"!=typeof t[r]||Array.isArray(t[r])||"links"===t[r]||m(t[r],e));return t}function g(t){var e,r=this,n={};return(e=t.property("relationships").value())&&a.forEach(e,function(t,e){n[e]=r._getRelationLink(t)}),n}function h(t){var e=this,r=[];if(Array.isArray(t.data)){var n=[];a.forEach(t.data,function(r){n.push({url:e.getResourceUrl(t.links.self,{type:e["default"].actionGetResource,id:r.id})})}),r=n}else r=[{url:e.getResourceUrl(t.links.self,{type:e["default"].actionGetResource,id:t.data.id})}];return r}function y(t){var e=[];return a.forEach(t,function(t){a.forEach(t,function(t){a.forEach(t,function(t){e.push(t.url)})})}),e}function v(t,e){var r=this;r.fetchCollection(y(t),function(r){var n=[];a.forEach(t,function(t,e){a.forEach(t,function(t,o){a.forEach(t,function(t,a){n[e]=n[e]||{},n[e][o]=n[e][o]||[],n[e][o][a]=r[t.url]})})}),e(n)})}var b,k={successDeleted:"Successfully delete",successCreated:"Successfully create",successUpdated:"Successfully update",serverError:"Oops! server error"};return{"default":{actionGetResource:"read"},TYPE_FORM:"form",TYPE_TABLE:"table",type:"",config:{},setModel:n,getModel:o,setMessage:s,getMessage:i,fetchData:p,fetchCollection:d,loadData:u,loadSchema:l,getResourceUrl:c,mergeRelSchema:f,_getRelationResource:g,_replaceFromFull:m,_getRelationLink:h,_batchLoadData:v}}var r={$get:t};return t.$inject=["$timeout","$interval","_"],r}function u(t,e){return function(e,r,a){function n(){e.getFormInfo(function(t){a.schema=t.schema,a.form=t.form,a.model=t.model,a.alerts.push({type:"success",msg:e.getMessage("successCreated")})})}function o(t){a.alerts.push({type:"danger",msg:t.statusText||e.getMessage("serverError")})}var i={method:r.method,url:r.href,data:a.model};return a.$broadcast("schemaFormValidate"),a.scopeForm.gridForm.$valid?void t(i).then(n,o):!1}}function l(t,e){return function(e,r,a){function n(){e.type===e.TYPE_TABLE?e.getTableInfo(function(t){a.rows=t.rows,a.columns=t.columns,a.links=t.links}):e.type===e.TYPE_FORM&&(a.hideForm=!0),a.alerts.push({type:"success",msg:e.getMessage("successDeleted")})}function o(t){a.alerts.push({type:"danger",msg:t.statusText||e.getMessage("serverError")})}var i={method:r.method,url:r.href};t(i).then(n,o)}}function p(t){return function(e,r){var a=r.definition.data.propertyValue("href"),n=a.replace(/{([^\{,}]*)}/g,function(t,e){return r.subjectData.propertyValue(e)});t.url(n)}}function d(){function t(t,e,r,a){return this.actions={goToUpdate:t,goToCreate:t,goToList:t,read:t,"delete":e,update:r,create:a},{action:function(t,e,r){this.actions[e.definition.data.propertyValue("rel")](t,e,r)}.bind(this)}}var e={actions:{},$get:t};return t.$inject=["grid-action-goTo","grid-action-delete","grid-action-update","grid-action-create"],e}function f(t,e){return function(e,r,a){function n(){e.getFormInfo(function(t){a.schema=t.schema,a.form=t.form,a.model=t.model,a.alerts.push({type:"success",msg:e.getMessage("successUpdated")})})}function o(t){a.alerts.push({type:"danger",msg:t.statusText||e.getMessage("serverError")})}var i={method:r.method,url:r.href,data:a.model};return a.$broadcast("schemaFormValidate"),a.scopeForm.gridForm.$valid?void t(i).then(n,o):!1}}function m(){function t(t,e,r,a){t.alerts=[],t.scopeForm={gridForm:{}},t.setFormScope=function(e){t.scopeForm=e};var n=new r;n.getFormInfo(function(e){t.schema=e.schema,t.form=e.form,t.model=e.model,t.links=e.links,t.$digest()}),t.edit=function(e,r){a.action(n,r.link,t)},t.go=function(e){a.action(n,e,t)},t.closeAlert=function(e){t.alerts.splice(e,1)}}var e={restrict:"E",replace:!0,controller:t};return t.$inject=["$scope","grid-entity","gridForm","grid-actions"],e}function g(t,e,r){function a(t,a){t.alerts=[];var n=new e,o=n.pagination;o.setCurrentPage(a.search().page),n.getTableInfo(function(e){t.setPagination(),t.rows=e.rows,t.columns=e.columns,t.links=e.links}),t.edit=function(e){r.action(n,e,t)},t.closeAlert=function(e){t.alerts.splice(e,1)},t.setPagination=function(){t.totalItems=o.getTotalCount(),t.currentPage=o.getCurrentPage(),t.itemsPerPage=o.getPerPage()},t.pageChanged=function(e){o.setCurrentPage(e),t.currentPage=o.getCurrentPage(),a.search("page",e)}}var n={restrict:"E",controller:a};return a.$inject=["$scope","$location"],n}function h(){function t(t,e){t.getTemplateUrl=function(){return t.gridModel.params.type?"templates/grid/form.html":"templates/grid/table.html"},e.setModel(t.gridModel)}var e={restrict:"E",template:'<ng-include src="getTemplateUrl()" />',scope:{gridModel:"=gridModel"},controller:t,link:function(t,e,r,a){}};return t.$inject=["$scope","grid-entity"],e}var y=[];try{t.module("schemaForm"),y.push("schemaForm")}catch(v){}try{t.module("ui.bootstrap"),y.push("ui.bootstrap")}catch(v){}var b=t.module("grid",y);return t.module("grid").factory("_",function(){return n}),t.module("grid").factory("gridForm",o),o.$inject=["grid-entity","$timeout","$interval","_"],t.module("grid").factory("gridPagination",i),i.$inject=["_"],t.module("grid").factory("gridTable",s),s.$inject=["grid-entity","gridPagination","$timeout","_"],t.module("grid").provider("grid-entity",c),Object.byString=function(t,e){e=e.replace(/\[(\w+)]/g,".$1"),e=e.replace(/\/(\w+)/g,".$1"),e=e.replace(/^\./,"");for(var r=e.split("."),a=0,n=r.length;n>a;++a){var o=r[a];if(!(o in t))return;t=t[o]}return t},t.module("grid").factory("grid-action-create",u),u.$inject=["$http","grid-entity"],t.module("grid").factory("grid-action-delete",l),l.$inject=["$http","grid-entity"],t.module("grid").factory("grid-action-goTo",p),p.$inject=["$location"],t.module("grid").provider("grid-actions",d),d.$inject=[],t.module("grid").factory("grid-action-update",f),f.$inject=["$http","grid-entity"],t.module("grid").run(["$templateCache",function(t){t.put("templates/grid/form.html",'<grid-form><span ng-repeat="link in links"><a href="javascript:void(0);" ng-click="go(link)">{{link.title}}</a> </span><div><alert ng-repeat="alert in alerts" type="{{alert.type}}" close="closeAlert($index)">{{alert.msg}}</alert></div><form novalidate name="gridForm" ng-init="setFormScope(this)"sf-schema="schema" sf-form="form" sf-model="model"class="form-horizontal" role="form" ng-if="hideForm !== true"></form></grid-form>')}]),t.module("grid").directive("gridForm",m),t.module("grid").run(["$templateCache",function(t){t.put("templates/grid/table.html",'<grid-table><span ng-repeat="link in links"><a href="javascript:void(0);" ng-click="edit(link)">{{link.title}}</a> </span><alert ng-repeat="alert in alerts" type="{{alert.type}}" close="closeAlert($index)">{{alert.msg}}</alert><table class="table grid"><thead><tr><th ng-repeat="column in columns"ng-class="{ \'sortable\': column.sortable(this), \'sort-asc\': params.sorting()[column.sortable(this)]==\'asc\', \'sort-desc\': params.sorting()[column.sortable(this)]==\'desc\' }"ng-click="sortBy(column, $event)">{{column.title}}</th></tr></thead><tbody><tr ng-repeat="row in rows"><td ng-repeat="column in columns"><span ng-if="column.attributeName !== \'links\'">{{row[column.attributeName]}}</span><span ng-if="column.attributeName == \'links\'"><span ng-repeat="link in row.links"><a href="javascript:void(0);" ng-click="edit(link)">{{link.title}}</a> </span></span></td></tr></tbody></table></grid-table><pagination ng-if="rows" direction-links="false" boundary-links="true" items-per-page="itemsPerPage" total-items="totalItems" ng-model="currentPage" ng-change="pageChanged(currentPage)"></pagination>')}]),t.module("grid").directive("gridTable",g),g.$inject=["grid-entity","gridTable","grid-actions"],t.module("grid").directive("vmsGrid",h),b});