!function(t,e){"function"==typeof define&&define.amd?define(["angular","jsonary","angular-bootstrap","bootstrap-decorator","lodash"],e):"object"==typeof exports?module.exports=e(require("angular"),require("Jsonary"),require("angularBootstrap"),require("bootstrapDecorator"),require("lodash")):t.vmsGrid=e(t.angular,t.Jsonary,t.angularBootstrap,t.bootstrapDecorator,t._)}(this,function(t,e,r,n,a){function o(e,r,n,a){function o(t){this.setModel(t),this.form=[],this.model={},this.schema={},this.links={}}function i(){var t=this;return{form:t.form,model:t.model,schema:t.schema,links:t.links}}function s(t){function e(e,r){var n=e.property("data").property("attributes"),i=o.mergeRelSchema(n.schemas()[0].data.value(),r);o.type=o.TYPE_FORM,o._getFieldsForm(e,function(r,n){function s(r){o.form=r,o.form=a.union(o.form,o._getFormButtonBySchema(e.property("data").links())),void 0!==t&&t(o.getConfig())}o.links=e.links(),o.schema=i,o.model=o._fieldsToFormFormat(r),o._getFormConfig(e,s)})}var n,o=this,i=o.getModel();n=o.getResourceUrl(i.url,i.params),r(function(){o.fetchData(n,e)})}function c(t){var e=t.own,r=e.property("attributes").value();return a.forEach(t.relationships,function(t,n){r[n]=a.map(t,function(t){return t.property("data").propertyValue("id")}),Array.isArray(e.property("relationships").property(n).propertyValue("data"))||(r[n]=r[n][0])}),r}function u(t,e){var n=this,o=[];n._createTitleMap(t.property("data"),function(i){var s=n.mergeRelSchema(t.property("data").schemas()[0].data.value(),t.schemas()[0].data.document.raw.value()).properties.attributes.properties;a.forEach(s,function(t,e){var r={key:e};i[e]&&(r.titleMap=i[e]),o.push(r)}),r(function(){e(o)})})}function l(t,e){function r(t){var r={own:n,relationships:a.mapValues(t[0],function(t){return a.forEach(t,function(e,r){t[r]=e.data}),t})};e(r)}var n,o=this,i=[];n=t.property("data"),i.push(o._getRelationResource(t.property("data"))),o._batchLoadData(i,r)}function d(t){var e=this,r=[],n=t.property("relationships"),o=t.property("attributes"),i=n.value(),s=(o.value(),t.schemas()[0].data.document.raw.value());return a.forEach(i,function(t,i){var c=t.links.self,u=n.property(i).schemas()[0].data.propertyValue("name"),l=e._replaceFromFull(o.schemas()[0].data.value(),s).properties[i],d={};l.items&&l.items["enum"]?d=l.items["enum"]:l["enum"]&&(d=l["enum"]),a.forEach(d,function(t){var n=e.getResourceUrl(c,{type:e["default"].actionGetResource,id:t});r.push({url:n,enumItem:t,relationName:i,attributeName:u})})}),r}function p(t,e){var r=this,n=r._getTitleMapsForRelations(t);r.fetchCollection(a.map(n,"url"),function(t){var r={};a.forEach(n,function(e){r[e.relationName]||(r[e.relationName]=[]),r[e.relationName].push({value:e.enumItem,name:t[e.url].data.property("data").property("attributes").propertyValue(e.attributeName)||e.enumItem})}),e(r)})}function f(t,e){function r(t){var e=t;return a.forEach(e,function(t,r){if(t.type)switch(t.type){case"object":e[r]={};break;case"string":e[r]="";break;case"array":e[r]=[];break;case"integer":e[r]=""}}),e}var n,o=this,i=o.mergeRelSchema(t,e);return n=a.clone(i.properties),n.data=r(a.clone(i.properties.data.properties)),n.data.attributes=r(a.clone(i.properties.data.properties.attributes.properties)),n}function g(t){var e=[];return a.forEach(t,function(t){e.push({type:"button",title:t.title,link:t,onClick:"edit($event, form)"})}),e}return t.extend(o.prototype,{getFormInfo:s,getConfig:i,_getTitleMapsForRelations:d,_createTitleMap:p,_getFormConfig:u,_getFieldsForm:l,_fieldsToFormFormat:c,_getEmptyData:f,_getFormButtonBySchema:g},e),o}function i(){function t(t){var e,r=t.indexOf("?");return r>=0&&(e=_.chain(t.slice(t.indexOf("?")+1).split("&")).map(function(t){return t?t.split("="):void 0}).compact().object().value()),e||{}}function e(t,e){var r,n=t.indexOf("?"),a=t;return n>=0&&(a=t.slice(0,n)),r=Object.keys(e).map(function(t){return t+"="+encodeURIComponent(e[t])}).join("&"),r=r?"?"+r:"",a+r}var r={parseLocationSearch:t,setLocationSearch:e};return r}function s(e,r){function n(){this.pageParam="page",this.currentPage=1,this.pageCount=0,this.perPage=1,this.totalCount=2}function a(){return this.pageParam}function o(t){this.totalCount=t}function i(){return this.totalCount}function s(t){this.perPage=t}function c(){return this.perPage}function u(){var t=this.perPage<1?1:Math.ceil(this.totalCount/this.perPage);return Math.max(t||0,1)}function l(t){this.currentPage=t}function d(){return this.currentPage}function p(){var t;return t=Math.max(this.currentPage||0,1)*this.perPage-this.perPage}function f(t){var r,n;return n=e.parseLocationSearch(t),n[this.pageParam+"[offset]"]=this.getOffset(),n[this.pageParam+"[limit]"]=this.getPerPage(),r=e.setLocationSearch(t,n)}return t.extend(n.prototype,{getPageParam:a,setTotalCount:o,getTotalCount:i,setPerPage:s,getPerPage:c,getPageCount:u,setCurrentPage:l,getCurrentPage:d,getOffset:p,getPageUrl:f}),n}function c(e,r){function n(){this.sortParam="sort"}function a(t){return t?"asc"==t?"desc":"":"asc"}function o(){return this.field?this.field.indexOf(".")>=0?this.field.slice(0,this.field.indexOf(".")):this.field:void 0}function i(t,e){this.field=t,this.direction=e}function s(t){this.sortFields=t}function c(t){var r,n;return this.field?(n=e.parseLocationSearch(t),n[this.sortParam+"["+this.field+"]"]=this.direction,r=e.setLocationSearch(t,n)):t}return n.DIRECTION_ASC="asc",n.DIRECTION_DESC="desc",n.field=void 0,n.direction="",n.sortFields=[],t.extend(n.prototype,{getColumn:o,getDirectionColumn:a,setSortFields:s,setSorting:i,getUrl:c}),n}function u(e,r,n,a,o){function i(t){this.setModel(t),this.pagination=new r,this.sorting=new n,this.rows=[],this.columns={},this.links={}}function s(){var t=this;return{rows:t.rows,columns:t.columns,links:t.links}}function c(t){function e(e,r){var a=n.mergeRelSchema(e.schemas()[0].data.value(),r);n.pagination.setTotalCount(e.property("meta").propertyValue("total")),n.type=n.TYPE_TABLE,n._getRowsByData(e,function(r){n.rows=n.rowsToTableFormat(r),n.links=e.links(),n.columns=n.getColumnsBySchema(a),n.sorting.setSortFields(o.map(n.columns,"attributeName")),n.columns.push({title:"Actions",type:"string",attributeName:"links"}),void 0!==t&&t(n.getConfig())})}var r,n=this,i=n.getModel();r=n.pagination.getPageUrl(n.getResourceUrl(i.url,i.params)),r=n.sorting.getUrl(r),a(function(){n.fetchData(r,e)})}function u(t,e){t=this.getSortingParamByField(t),this.sorting.setSorting(t,e)}function l(t){var e=t,r=this.data.property("data").item(0).property("relationships").property(t);if(r.value()){var n=r.schemas()[0].data.value().name;e+="."+n}return e}function d(t){var e=[],r=t.properties.data.items.properties.attributes.properties;return o.forEach(r,function(t,r){t.attributeName=r,e.push(t)}),e}function p(t){var e=[];return o.forEach(t,function(t){var r=t.own,n=r.property("attributes").value();o.forEach(t.relationships,function(e,r){n[r]=o.map(e,function(e){var n=t.own.property("relationships").property(r).schemas()[0].data.propertyValue("name");return n?e.property("data").property("attributes").propertyValue(n):e.property("data").propertyValue("id")}).join(", ")}),n.links=[],o.forOwn(r.links(),function(t){n.links.push(t)}),e.push(n)}),e}function f(t,e){function r(t){var r=[];o.forEach(a,function(e,n){var a={own:e,relationships:o.mapValues(t[n],function(t){return o.forEach(t,function(e,r){t[r]=e.data}),t})};r.push(a)}),e(r)}var n=this,a=[],i=[];t.property("data").items(function(t,e){i.push(n._getRelationResource(e)),a.push(e)}),n._batchLoadData(i,r)}return t.extend(i.prototype,{getConfig:s,getTableInfo:c,getColumnsBySchema:d,rowsToTableFormat:p,getSortingParamByField:l,setSorting:u,_getRowsByData:f},e),i}function l(){function t(t,r,n){function a(t){b=t}function o(){return b}function i(t){return P[t]}function s(t,e){P[t]=e}function c(t,e){var r=t;return e.resource&&(r=t+"/"+e.resource),e.type&&("update"===e.type||"read"===e.type?r+="/"+e.type+"/"+e.id:"create"===e.type&&(r+="/schema#/definitions/create")),r}function u(t,r){return void 0===b?(alert("Please set model before call fetch data"),!1):void e.getData(t,function(t,e){var n=t,a=t.property("data").schemas()[0].data.document.raw.value();void 0!==r&&r(n,a,e)})}function l(t,r){var n=this;e.getSchema(t,function(t){var a=t.data.document.raw.value(),o=e.create(n._getEmptyData(t.data.value(),a));o.document.url=n.getModel().url,o.addSchema(t),void 0!==r&&r(o,a)})}function d(t,e){function r(t,r){n.data=t,void 0!==e&&e(t,r)}var n=this;"create"===b.params.type?n.loadSchema(t,r):n.loadData(t,r)}function p(t,e){var a,o=this,i=0,s=0,c={};a=n.uniq(t),n.forEach(a,function(t){o.loadData(t,function(e,r,n){c[t]={data:e,schema:r,request:n},i++}),s++});var u=r(function(){s===i&&(r.cancel(u),void 0!==e&&e(c))},100)}function f(t,e){var r=t;return r=g(r,e)}function g(t,e){for(var r in t)t.hasOwnProperty(r)&&("object"==typeof t[r]&&!Array.isArray(t[r])&&t[r].$ref&&(t[r]=Object.byString(e,t[r].$ref.substring(2)),g(t[r],e)),"object"!=typeof t[r]||Array.isArray(t[r])||"links"===t[r]||g(t[r],e));return t}function m(t){var e,r=this,a={};return(e=t.property("relationships").value())&&n.forEach(e,function(t,e){a[e]=r._getRelationLink(t)}),a}function h(t){var e=this,r=[];if(Array.isArray(t.data)){var a=[];n.forEach(t.data,function(r){a.push({url:e.getResourceUrl(t.links.self,{type:e["default"].actionGetResource,id:r.id})})}),r=a}else r=[{url:e.getResourceUrl(t.links.self,{type:e["default"].actionGetResource,id:t.data.id})}];return r}function v(t){var e=[];return n.forEach(t,function(t){n.forEach(t,function(t){n.forEach(t,function(t){e.push(t.url)})})}),e}function y(t,e){var r=this;r.fetchCollection(v(t),function(r){var a=[];n.forEach(t,function(t,e){n.forEach(t,function(t,o){n.forEach(t,function(t,n){a[e]=a[e]||{},a[e][o]=a[e][o]||[],a[e][o][n]=r[t.url]})})}),e(a)})}var b,P={successDeleted:"Successfully delete",successCreated:"Successfully create",successUpdated:"Successfully update",serverError:"Oops! server error"};return this.data={},{"default":{actionGetResource:"read"},TYPE_FORM:"form",TYPE_TABLE:"table",type:"",config:{},setModel:a,getModel:o,setMessage:s,getMessage:i,fetchData:d,fetchCollection:p,loadData:u,loadSchema:l,getResourceUrl:c,mergeRelSchema:f,_getRelationResource:m,_replaceFromFull:g,_getRelationLink:h,_batchLoadData:y}}var r={$get:t};return t.$inject=["$timeout","$interval","_"],r}function d(t,e){return function(e,r,n){function a(){e.getFormInfo(function(t){n.schema=t.schema,n.form=t.form,n.model=t.model,n.alerts.push({type:"success",msg:e.getMessage("successCreated")})})}function o(t){n.alerts.push({type:"danger",msg:t.statusText||e.getMessage("serverError")})}var i={method:r.method,url:r.href,data:n.model};return n.$broadcast("schemaFormValidate"),n.scopeForm.gridForm.$valid?void t(i).then(a,o):!1}}function p(t,e){return function(e,r,n){function a(){e.type===e.TYPE_TABLE?e.getTableInfo(function(t){n.rows=t.rows,n.columns=t.columns,n.links=t.links}):e.type===e.TYPE_FORM&&(n.hideForm=!0),n.alerts.push({type:"success",msg:e.getMessage("successDeleted")})}function o(t){n.alerts.push({type:"danger",msg:t.statusText||e.getMessage("serverError")})}var i={method:r.method,url:r.href};t(i).then(a,o)}}function f(t){return function(e,r){var n=r.definition.data.propertyValue("href"),a=n.replace(/{([^\{,}]*)}/g,function(t,e){return r.subjectData.propertyValue(e)});t.url(a)}}function g(){function t(t,e,r,n){return this.actions={goToUpdate:t,goToCreate:t,goToList:t,read:t,"delete":e,update:r,create:n},{action:function(t,e,r){this.actions[e.definition.data.propertyValue("rel")](t,e,r)}.bind(this)}}var e={actions:{},$get:t};return t.$inject=["grid-action-goTo","grid-action-delete","grid-action-update","grid-action-create"],e}function m(t,e){return function(e,r,n){function a(){e.getFormInfo(function(t){n.schema=t.schema,n.form=t.form,n.model=t.model,n.alerts.push({type:"success",msg:e.getMessage("successUpdated")})})}function o(t){n.alerts.push({type:"danger",msg:t.statusText||e.getMessage("serverError")})}var i={method:r.method,url:r.href,data:n.model};return n.$broadcast("schemaFormValidate"),n.scopeForm.gridForm.$valid?void t(i).then(a,o):!1}}function h(){function t(t,e,r){t.alerts=[],t.scopeForm={gridForm:{}},t.setFormScope=function(e){t.scopeForm=e};var n=new e(t.gridModel);n.getFormInfo(function(e){t.schema=e.schema,t.form=e.form,t.model=e.model,t.links=e.links,t.$digest()}),t.edit=function(e,a){r.action(n,a.link,t)},t.go=function(e){r.action(n,e,t)},t.closeAlert=function(e){t.alerts.splice(e,1)}}var e={restrict:"E",replace:!0,controller:t};return t.$inject=["$scope","gridForm","grid-actions"],e}function v(t,e){function r(r,n){function a(t){var e=o.sorting;if(!t[e.sortParam])return!1;var r=t[e.sortParam].lastIndexOf("_"),n=t[e.sortParam].slice(0,r),a=t[e.sortParam].slice(r+1);e.setSorting(n,a)}r.alerts=[];var o=new t(r.gridModel),i=o.pagination;r.tableInst=o,i.setCurrentPage(n.search().page),a(n.search()),o.getTableInfo(function(t){r.setPagination(),r.rows=t.rows,r.columns=t.columns,r.links=t.links,r.$broadcast("onLoadData")}),r.edit=function(t){e.action(o,t,r)},r.closeAlert=function(t){r.alerts.splice(t,1)},r.setPagination=function(){r.totalItems=i.getTotalCount(),r.currentPage=i.getCurrentPage(),r.itemsPerPage=i.getPerPage()},r.pageChanged=function(t){i.setCurrentPage(t),r.currentPage=i.getCurrentPage(),n.search("page",t)}}var n={restrict:"E",controller:r};return r.$inject=["$scope","$location"],n}function y(){function t(t,e){var r=t.tableInst.sorting;t.$on("onLoadData",function(){t.columns=t.tableInst.columns,t.sortFields=r.sortFields,t.setSorting()}),t.setSorting=function(){var t=r.getColumn();t&&(_.where(this.columns,{attributeName:t})[0].sorting=r.direction)},t.sortBy=function(n,a){n.sorting=r.getDirectionColumn(n.sorting),t.tableInst.setSorting(n.attributeName,n.sorting);var o=t.tableInst.getSortingParamByField(n.attributeName);n.sorting?e.search("sort",o+"_"+n.sorting):e.search("sort",null)}}var e={scope:{tableInst:"=table"},require:"^gridTable",templateUrl:"templates/grid/table-head.html",restrict:"A",controller:t,link:function(t,e,r){}};return t.$inject=["$scope","$location"],e}function b(){function t(t){t.getTemplateUrl=function(){return t.gridModel.params.type?"templates/grid/form.html":"templates/grid/table.html"}}var e={restrict:"E",template:'<ng-include src="getTemplateUrl()" />',scope:{gridModel:"=gridModel"},controller:t,link:function(t,e,r,n){}};return t.$inject=["$scope"],e}var P=[];try{t.module("schemaForm"),P.push("schemaForm")}catch(k){}try{t.module("ui.bootstrap"),P.push("ui.bootstrap")}catch(k){}var F=t.module("grid",P);return t.module("grid").factory("_",function(){return a}),t.module("grid").factory("gridForm",o),o.$inject=["grid-entity","$timeout","$interval","_"],t.module("grid").factory("Helper",i),i.$inject=["_"],t.module("grid").factory("gridPagination",s),s.$inject=["Helper","_"],t.module("grid").factory("Sorting",c),c.$inject=["Helper","_"],t.module("grid").factory("gridTable",u),u.$inject=["grid-entity","gridPagination","Sorting","$timeout","_"],t.module("grid").provider("grid-entity",l),Object.byString=function(t,e){e=e.replace(/\[(\w+)]/g,".$1"),e=e.replace(/\/(\w+)/g,".$1"),e=e.replace(/^\./,"");for(var r=e.split("."),n=0,a=r.length;a>n;++n){var o=r[n];if(!(o in t))return;t=t[o]}return t},t.module("grid").factory("grid-action-create",d),d.$inject=["$http","grid-entity"],t.module("grid").factory("grid-action-delete",p),p.$inject=["$http","grid-entity"],t.module("grid").factory("grid-action-goTo",f),f.$inject=["$location"],t.module("grid").provider("grid-actions",g),g.$inject=[],t.module("grid").factory("grid-action-update",m),m.$inject=["$http","grid-entity"],t.module("grid").directive("gridForm",h),t.module("grid").directive("gridTable",v),v.$inject=["gridTable","grid-actions"],t.module("grid").directive("gridThead",y),y.$inject=[],t.module("grid").directive("vmsGrid",b),t.module("grid").run(["$templateCache",function(t){t.put("templates/grid/form.html",'<grid-form>\n    <span ng-repeat="link in links">\n    <a href="javascript:void(0);" ng-click="go(link)">{{link.title}}</a>\n    </span>\n\n    <div>\n        <alert ng-repeat="alert in alerts" type="{{alert.type}}" close="closeAlert($index)">{{alert.msg}}</alert>\n    </div>\n    <form novalidate name="gridForm" ng-init="setFormScope(this)"\n          sf-schema="schema" sf-form="form" sf-model="model"\n          class="form-horizontal" role="form" ng-if="hideForm !== true">\n    </form>\n</grid-form>'),t.put("templates/grid/table-head.html",'<tr>\n    <th ng-repeat="column in columns">\n        <div ng-if="sortFields.indexOf(column.attributeName)>=0" class="th-inner sortable" ng-click="sortBy(column, $event)">{{column.title}}\n            <span ng-if="column.sorting" class="order" ng-class="{\'dropup\': column.sorting==\'desc\'}">\n                <span class="caret" style="margin: 0px 5px;"></span>\n            </span>\n        </div>\n        <div ng-if="sortFields.indexOf(column.attributeName)<0" class="th-inner">{{column.title}}</div>\n    </th>\n</tr>\n'),t.put("templates/grid/table.html",'<grid-table>\n    <span ng-repeat="link in links">\n        <a href="javascript:void(0);" ng-click="edit(link)">{{link.title}}</a>\n      </span>\n    <alert ng-repeat="alert in alerts" type="{{alert.type}}" close="closeAlert($index)">{{alert.msg}}</alert>\n\n    <table class="table grid">\n        <thead grid-thead table="tableInst"></thead>\n        <tbody>\n            <tr ng-repeat="row in rows">\n                <td ng-repeat="column in columns">\n                    <span ng-if="column.attributeName !== \'links\'">{{row[column.attributeName]}}</span>\n                    <span ng-if="column.attributeName == \'links\'">\n                        <span ng-repeat="link in row.links">\n                            <a href="javascript:void(0);" ng-click="edit(link)">{{link.title}}</a>\n                        </span>\n                    </span>\n                </td>\n            </tr>\n        </tbody>\n    </table>\n</grid-table>\n<pagination ng-if="rows" direction-links="false" boundary-links="true" items-per-page="itemsPerPage" total-items="totalItems" ng-model="currentPage" ng-change="pageChanged(currentPage)"></pagination>')}]),F});