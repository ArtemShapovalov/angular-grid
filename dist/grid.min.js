!function(t,e){"function"==typeof define&&define.amd?define(["angular","jsonary","angular-bootstrap","bootstrap-decorator","lodash"],e):"object"==typeof exports?module.exports=e(require("angular"),require("Jsonary"),require("angularBootstrap"),require("bootstrapDecorator"),require("lodash")):t.vmsGrid=e(t.angular,t.Jsonary,t.angularBootstrap,t.bootstrapDecorator,t._)}(this,function(t,e,r,a,o){function n(){function t(t,o,n){function i(t){r=t}function c(t){a=t}function s(t){S=t}function u(){return S}function l(t){return L[t]}function f(t,e){L[t]=e}function p(t,e){function r(t,r){a.setData(t),a.setSchema(r),void 0!==e&&e(t,r)}var a=this;"create"===S.params.type?a.loadSchema(t,r):a.loadData(t,r)}function d(t,r){return void 0===S?(alert("Please set model before call fetch data"),!1):void e.getData(t,function(t,e){var a=t,o=t.property("data").schemas()[0].data.document.raw.value();void 0!==r&&r(a,o,e)})}function m(t,r){var a=this;e.getSchema(t,function(t){var o=t.data.document.raw.value(),n=e.create(a._getEmptyData(t.data.value(),o));n.document.url=a.getModel().url,n.addSchema(t),void 0!==r&&r(n,o)})}function g(t,e){function r(t){var e=t;return n.forEach(e,function(t,r){if(t.type)switch(t.type){case"object":e[r]={};break;case"string":e[r]="";break;case"array":e[r]=[];break;case"integer":e[r]=""}}),e}var a,o=_(t,e);return a=n.clone(o.properties),a.data=r(n.clone(o.properties.data.properties)),a.data.attributes=r(n.clone(o.properties.data.properties.attributes.properties)),a}function h(t,e){var r=t;return e.resource&&(r=t+"/"+e.resource),e.type&&("update"===e.type||"read"===e.type?r+="/"+e.type+"/"+e.id:"create"===e.type&&(r+="/schema#/definitions/create")),r}function y(e){function r(t,r){var a=_(t.schemas()[0].data.value(),r);o.type=o.TYPE_TABLE,o.config.table||(o.config.table={}),o._getRowsByData(t,function(r,n){o.config.table.rows=M(r),o.config.table.links=t.links(),o.config.table.columns=w(a),o.config.table.columns.push({title:"Actions",type:"string",attributeName:"links"}),void 0!==e&&e(o.config.table)})}var a,o=this,n=o.getModel();a=h(n.url,n.params),t(function(){o.fetchData(a,r)})}function v(e){function r(t,r){var a=t.property("data").property("attributes"),i=_(a.schemas()[0].data.value(),r);o.type=o.TYPE_FORM,o.config.form||(o.config.form={}),o._getFieldsForm(t,function(r,a){function c(r){o.config.form.form=r,o.config.form.form=n.union(o.config.form.form,V(t.property("data").links())),void 0!==e&&e(o.config.form)}o.config.form.links=t.links(),o.config.form.schema=i,o.config.form.model=T(r),o._getFormConfig(t,c)})}var a,o=this,i=o.getModel();a=h(i.url,i.params),t(function(){o.fetchData(a,r)})}function b(e,r){var a=this,o=[];a._createTitleMap(e.property("data"),function(a){var i=_(e.property("data").schemas()[0].data.value(),e.schemas()[0].data.document.raw.value()).properties.attributes.properties;n.forEach(i,function(t,e){var r={key:e};a[e]&&(r.titleMap=a[e]),o.push(r)}),t(function(){r(o)})})}function k(t,e){function r(t){var r={own:a,relationships:n.mapValues(t[0],function(t){return n.forEach(t,function(e,r){t[r]=e.data}),t})};e(r)}var a,o=this,i=[];a=t.property("data"),i.push(o._getRelationResource(t.property("data"))),o._batchLoadData(i,r)}function E(t,e){var r=this,a={},i=0,c=0,s=t.property("relationships"),u=t.property("attributes"),l=s.value(),f=(u.value(),t.schemas()[0].data.document.raw.value()),p=[];n.forEach(l,function(t,e){var o=t.links.self,l=s.property(e).schemas()[0].data.propertyValue("name"),d=r._replaceFromFull(u.schemas()[0].data.value(),f).properties[e],m={};d.items&&d.items["enum"]?m=d.items["enum"]:d["enum"]&&(m=d["enum"]),m&&(a[e]=[],n.forEach(m,function(t){var n=o+"/"+r["default"].actionGetResource+"/"+t;p.push(n),r.loadData(n,function(r,o){a[e].push({value:t,name:r.property("data").property("attributes").propertyValue(l)||t}),i++}),c++}))}),$(p,function(){});var d=o(function(){c===i&&(o.cancel(d),void 0!==e&&e(a))},100)}function $(t,e,r){}function F(t,e){for(var r in t)t.hasOwnProperty(r)&&("object"==typeof t[r]&&!Array.isArray(t[r])&&t[r].$ref&&(t[r]=Object.byString(e,t[r].$ref.substring(2)),F(t[r],e)),"object"!=typeof t[r]||Array.isArray(t[r])||"links"===t[r]||F(t[r],e));return t}function _(t,e){var r=t;return r=F(r,e)}function w(t){var e=[],r=t.properties.data.items.properties.attributes.properties;return n.forEach(r,function(t,r){t.attributeName=r,e.push(t)}),e}function T(t){var e=t.own,r=e.property("attributes").value();return n.forEach(t.relationships,function(t,a){r[a]=n.map(t,function(t){return t.property("data").propertyValue("id")}),Array.isArray(e.property("relationships").property(a).propertyValue("data"))||(r[a]=r[a][0])}),r}function M(t){var e=[];return n.forEach(t,function(t){var r=t.own,a=r.property("attributes").value();n.forEach(t.relationships,function(e,r){a[r]=n.map(e,function(e){var a=t.own.property("relationships").property(r).schemas()[0].data.propertyValue("name");return a?e.property("data").property("attributes").propertyValue(a):e.property("data").propertyValue("id")}).join(", ")}),a.links=[],n.forOwn(r.links(),function(t){a.links.push(t)}),e.push(a)}),e}function j(t,e){function r(t){var r=[];n.forEach(o,function(e,a){var o={own:e,relationships:n.mapValues(t[a],function(t){return n.forEach(t,function(e,r){t[r]=e.data}),t})};r.push(o)}),e(r)}var a=this,o=[],i=[];t.property("data").items(function(t,e){i.push(a._getRelationResource(e)),o.push(e)}),a._batchLoadData(i,r)}function D(t){var e,r=this,a={};return(e=t.property("relationships").value())&&n.forEach(e,function(t,e){a[e]=r._getRelationLink(t)}),a}function R(t){var e=this,r=[];if(Array.isArray(t.data)){var a=[];n.forEach(t.data,function(r){a.push({url:h(t.links.self,{type:e["default"].actionGetResource,id:r.id})})}),r=a}else r=[{url:h(t.links.self,{type:e["default"].actionGetResource,id:t.data.id})}];return r}function A(t,e){function r(t,e){i[t.document.url]={data:t,schema:e},console.log("load")}var a=[],i={},c={},s=0,u=0;n.forEach(t,function(t){n.forEach(t,function(t){n.forEach(t,function(t){c[t.url]?(console.log("cache"),s++):(d(t.url,r),c[t.url]={},s++,u++)})})});var l=o(function(){n.size(i)===u&&(o.cancel(l),n.forEach(t,function(t,e){n.forEach(t,function(t,r){n.forEach(t,function(t,o){a[e]=a[e]||{},a[e][r]=a[e][r]||[],a[e][r][o]=i[t.url]})})}),e(a))},100)}function V(t){var e=[];return n.forEach(t,function(t){e.push({type:"button",title:t.title,link:t,onClick:"edit($event, form)"})}),e}var S,L={successDeleted:"Successfully delete",successCreated:"Successfully create",successUpdated:"Successfully update",serverError:"Oops! server error"};return{"default":{actionGetResource:"read"},TYPE_FORM:"form",TYPE_TABLE:"table",type:"",config:{},setData:i,setModel:s,getModel:u,setSchema:c,getMessage:l,setMessage:f,fetchData:p,loadData:d,loadSchema:m,getTableInfo:y,getFormInfo:v,_getRelationResource:D,_replaceFromFull:F,_getRelationLink:R,_createTitleMap:E,_getFormConfig:b,_getFieldsForm:k,_getRowsByData:j,_getEmptyData:g,_batchLoadData:A}}var r,a,o={$get:t};return t.$inject=["$timeout","$interval","_"],o}function i(t,e){return function(r,a){function o(){e.getFormInfo(function(t){a.schema=t.schema,a.form=t.form,a.model=t.model,a.alerts.push({type:"success",msg:e.getMessage("successCreated")})})}function n(t){a.alerts.push({type:"danger",msg:t.statusText||e.getMessage("serverError")})}var i={method:r.method,url:r.href,data:a.model};return a.$broadcast("schemaFormValidate"),a.scopeForm.gridForm.$valid?void t(i).then(o,n):!1}}function c(t,e){return function(r,a){function o(){e.type===e.TYPE_TABLE?e.getTableInfo(function(t){a.rows=t.rows,a.columns=t.columns,a.links=t.links}):e.type===e.TYPE_FORM&&(a.hideForm=!0),a.alerts.push({type:"success",msg:e.getMessage("successDeleted")})}function n(t){a.alerts.push({type:"danger",msg:t.statusText||e.getMessage("serverError")})}var i={method:r.method,url:r.href};t(i).then(o,n)}}function s(t){return function(e){var r=e.definition.data.propertyValue("href"),a=r.replace(/{([^\{,}]*)}/g,function(t,r){return e.subjectData.propertyValue(r)});t.url(a)}}function u(){function t(t,e,r,a){return this.actions={goToUpdate:t,goToCreate:t,goToList:t,read:t,"delete":e,update:r,create:a},{action:function(t,e){this.actions[t.definition.data.propertyValue("rel")](t,e)}.bind(this)}}var e={actions:{},$get:t};return t.$inject=["grid-action-goTo","grid-action-delete","grid-action-update","grid-action-create"],e}function l(t,e){return function(r,a){function o(){e.getFormInfo(function(t){a.schema=t.schema,a.form=t.form,a.model=t.model,a.alerts.push({type:"success",msg:e.getMessage("successUpdated")})})}function n(t){a.alerts.push({type:"danger",msg:t.statusText||e.getMessage("serverError")})}var i={method:r.method,url:r.href,data:a.model};return a.$broadcast("schemaFormValidate"),a.scopeForm.gridForm.$valid?void t(i).then(o,n):!1}}function f(){function t(t,e,r){t.alerts=[],t.scopeForm={gridForm:{}},t.setFormScope=function(e){t.scopeForm=e},e.getFormInfo(function(e){t.schema=e.schema,t.form=e.form,t.model=e.model,t.links=e.links,t.$digest()}),t.edit=function(e,a){r.action(a.link,t)},t.go=function(e){r.action(e,t)},t.closeAlert=function(e){t.alerts.splice(e,1)}}var e={restrict:"E",replace:!0,controller:t};return t.$inject=["$scope","grid-entity","grid-actions"],e}function p(t,e){function r(r){r.alerts=[],t.getTableInfo(function(t){r.rows=t.rows,r.columns=t.columns,r.links=t.links}),r.edit=function(t){e.action(t,r)},r.closeAlert=function(t){r.alerts.splice(t,1)}}var a={restrict:"E",controller:r};return r.$inject=["$scope"],a}function d(){function t(t,e){t.getTemplateUrl=function(){return t.gridModel.params.type?"templates/grid/form.html":"templates/grid/table.html"},e.setModel(t.gridModel)}var e={restrict:"E",template:'<ng-include src="getTemplateUrl()" />',scope:{gridModel:"=gridModel"},controller:t,link:function(t,e,r,a){}};return t.$inject=["$scope","grid-entity"],e}var m=[];try{t.module("schemaForm"),m.push("schemaForm")}catch(g){}try{t.module("ui.bootstrap"),m.push("ui.bootstrap")}catch(g){}var h=t.module("grid",m);return t.module("grid").run(["$templateCache",function(t){t.put("templates/grid/table.html",'<grid-table><span ng-repeat="link in links"><a href="javascript:void(0);" ng-click="edit(link)">{{link.title}}</a> </span><alert ng-repeat="alert in alerts" type="{{alert.type}}" close="closeAlert($index)">{{alert.msg}}</alert><table class="table grid"><thead><tr><th ng-repeat="column in columns">{{column.title}}</th></tr></thead><tbody><tr ng-repeat="row in rows"><td ng-repeat="column in columns"><span ng-if="column.attributeName !== \'links\'">{{row[column.attributeName]}}</span><span ng-if="column.attributeName == \'links\'"><span ng-repeat="link in row.links"><a href="javascript:void(0);" ng-click="edit(link)">{{link.title}}</a> </span></span></td></tr></tbody></table></grid-table>'),t.put("templates/grid/form.html",'<grid-form><span ng-repeat="link in links"><a href="javascript:void(0);" ng-click="go(link)">{{link.title}}</a> </span><div><alert ng-repeat="alert in alerts" type="{{alert.type}}" close="closeAlert($index)">{{alert.msg}}</alert></div><form novalidate name="gridForm" ng-init="setFormScope(this)"sf-schema="schema" sf-form="form" sf-model="model"class="form-horizontal" role="form" ng-if="hideForm !== true"></form></grid-form>')}]),t.module("grid").factory("_",function(){return o}),t.module("grid").provider("grid-entity",n),Object.byString=function(t,e){e=e.replace(/\[(\w+)]/g,".$1"),e=e.replace(/\/(\w+)/g,".$1"),e=e.replace(/^\./,"");for(var r=e.split("."),a=0,o=r.length;o>a;++a){var n=r[a];if(!(n in t))return;t=t[n]}return t},t.module("grid").factory("grid-action-create",i),i.$inject=["$http","grid-entity"],t.module("grid").factory("grid-action-delete",c),c.$inject=["$http","grid-entity"],t.module("grid").factory("grid-action-goTo",s),s.$inject=["$location"],t.module("grid").provider("grid-actions",u),u.$inject=[],t.module("grid").factory("grid-action-update",l),l.$inject=["$http","grid-entity"],t.module("grid").directive("gridForm",f),t.module("grid").directive("gridTable",p),p.$inject=["grid-entity","grid-actions"],t.module("grid").directive("vmsGrid",d),h});