!function(e,t){"function"==typeof define&&define.amd?define(["angular","jsonary","angular-bootstrap","bootstrap-decorator","lodash"],t):"object"==typeof exports?module.exports=t(require("angular"),require("Jsonary"),require("angularBootstrap"),require("bootstrapDecorator"),require("lodash")):e.vmsGrid=t(e.angular,e.Jsonary,e.angularBootstrap,e.bootstrapDecorator,e._)}(this,function(e,t,r,o,n){function a(){function e(e,n){function a(e){r=e}function i(e){o=e}function c(e){w=e}function s(){return w}function u(e){return A[e]}function l(e,t){A[e]=t}function d(e,t){function r(e,r){o.setData(e),o.setSchema(r),void 0!==t&&t(e,r)}var o=this;"create"===w.params.type?o.loadSchema(e,r):o.loadData(e,r)}function f(e,r){return void 0===w?(alert("Please set model before call fetch data"),!1):void t.getData(e,function(e,t){var o=e,n=e.property("data").schemas()[0].data.document.raw.value();void 0!==r&&r(o,n,t)})}function p(e,r){var o=this;t.getSchema(e,function(e){var n=e.data.document.raw.value(),a=t.create(m(e.data.value(),n));a.document.url=o.getModel().url,a.addSchema(e),void 0!==r&&r(a,n)})}function m(e,t){function r(e){var t=e;return n.forEach(t,function(e,r){if(e.type)switch(e.type){case"object":t[r]={};break;case"string":t[r]="";break;case"array":t[r]=[];break;case"integer":t[r]=""}}),t}var o,a=b(e,t);return o=n.clone(a.properties),o.data=r(n.clone(a.properties.data.properties)),o.data.attributes=r(n.clone(a.properties.data.properties.attributes.properties)),o}function g(e,t){var r=e;return t.resource&&(r=e+"/"+t.resource),t.type&&("update"===t.type||"read"===t.type?r+="/"+t.type+"/"+t.id:"create"===t.type&&(r+="/schema#/definitions/create")),r}function h(t){function r(e,r){var o=b(e.schemas()[0].data.value(),r);n.type=n.TYPE_TABLE,n.config.table||(n.config.table={}),E(e,function(r,a){n.config.table.rows=$(r),n.config.table.links=e.links(),n.config.table.columns=k(o),n.config.table.columns.push({title:"Actions",type:"string",attributeName:"links"}),void 0!==t&&t(n.config.table)})}var o,n=this,a=n.getModel();o=g(a.url,a.params),e(function(){n.fetchData(o,r)})}function v(t){function r(e,r){var o=e.property("data").property("attributes"),i=b(o.schemas()[0].data.value(),r);a.type=a.TYPE_FORM,a.config.form||(a.config.form={}),a.config.form.links=e.links(),a.config.form.schema=i,a.config.form.model=o.value(),a.config.form.form=["*"],a.config.form.form=n.union(a.config.form.form,M(e.property("data").links())),void 0!==t&&t(a.config.form)}var o,a=this,i=a.getModel();o=g(i.url,i.params),e(function(){a.fetchData(o,r)})}function y(e,t){for(var r in e)e.hasOwnProperty(r)&&("object"==typeof e[r]&&!Array.isArray(e[r])&&e[r].$ref&&(e[r]=Object.byString(t,e[r].$ref.substring(2)),y(e[r],t)),"object"!=typeof e[r]||Array.isArray(e[r])||"links"===e[r]||y(e[r],t));return e}function b(e,t){var r=e;return r=y(r,t)}function k(e){var t=[],r=e.properties.data.items.properties.attributes.properties,o={};return e.properties.data.items.properties.relationships&&(o=e.properties.data.items.properties.relationships.properties),n.forEach(r,function(e,r){e.attributeName=r,t.push(e)}),n.forEach(o,function(e,r){e.attributeName=r,t.push(e)}),t}function $(e){var t=[];return n.forEach(e,function(e){var r=e.own,o=r.property("attributes").value();n.forEach(e.relationships,function(t,r){o[r]=n.map(t,function(t){var o=e.own.property("relationships").property(r).schemas()[0].data.propertyValue("name");return o?t.property("data").property("attributes").propertyValue(o):t.property("data").propertyValue("id")}).join(", ")}),o.links=[],n.forOwn(r.links(),function(e){o.links.push(e)}),t.push(o)}),t}function E(e,t){function r(e){var r=[];n.forEach(o,function(t,o){var a={own:t,relationships:n.mapValues(e[o],function(e){return n.forEach(e,function(t,r){e[r]=t.data}),e})};r.push(a)}),t(r)}var o=[],a=[];e.property("data").items(function(e,t){a.push(F(t)),o.push(t)}),T(a,r)}function F(e){var t,r={};return(t=e.property("relationships").value())&&n.forEach(t,function(e,t){r[t]=j(e)}),r}function j(e){var t=[];if(Array.isArray(e.data)){var r=[];n.forEach(e.data,function(t){r.push({url:g(e.links.self,{type:"read",id:t.id})})}),t=r}else t=[{url:g(e.links.self,{type:"read",id:e.data.id})}];return t}function T(e,t){function r(e,t,r){a[e.document.url]={data:e,schema:t},console.log("load")}var o=[],a={},i={},c=0;n.forEach(e,function(e){n.forEach(e,function(e){n.forEach(e,function(e){i[e.url]?(console.log("cache"),c++):(f(e.url,r),i[e.url]={},c++)})})});var s=setInterval(function(){n.size(a)+n.size(i)===c&&(clearInterval(s),n.forEach(e,function(e,t){n.forEach(e,function(e,r){n.forEach(e,function(e,n){o[t]=o[t]||{},o[t][r]=o[t][r]||[],o[t][r][n]=a[e.url]})})}),t(o))},100)}function M(e){var t=[];return n.forEach(e,function(e){t.push({type:"button",title:e.title,link:e,onClick:"edit($event, form)"})}),t}var w,A={successDeleted:"Successfully delete",successCreated:"Successfully create",successUpdated:"Successfully update",serverError:"Oops! server error"};return{TYPE_FORM:"form",TYPE_TABLE:"table",type:"",config:{},setData:a,setModel:c,getModel:s,setSchema:i,getMessage:u,setMessage:l,fetchData:d,loadData:f,loadSchema:p,getTableInfo:h,getFormInfo:v}}var r,o,n={$get:e};return e.$inject=["$timeout","_"],n}function i(e,t){return function(r,o){function n(){t.getFormInfo(function(e){o.schema=e.schema,o.form=e.form,o.model=e.model,o.alerts.push({type:"success",msg:t.getMessage("successCreated")})})}function a(e){o.alerts.push({type:"danger",msg:e.statusText||t.getMessage("serverError")})}var i={method:r.method,url:r.href,data:o.model};return o.$broadcast("schemaFormValidate"),o.scopeForm.gridForm.$valid?void e(i).then(n,a):!1}}function c(e,t){return function(r,o){function n(){t.type===t.TYPE_TABLE?t.getTableInfo(function(e){o.rows=e.rows,o.columns=e.columns,o.links=e.links}):t.type===t.TYPE_FORM&&(o.hideForm=!0),o.alerts.push({type:"success",msg:t.getMessage("successDeleted")})}function a(e){o.alerts.push({type:"danger",msg:e.statusText||t.getMessage("serverError")})}var i={method:r.method,url:r.href};e(i).then(n,a)}}function s(e){return function(t){var r=t.definition.data.propertyValue("href"),o=r.replace(/{([^\{,}]*)}/g,function(e,r){return t.subjectData.propertyValue(r)});e.url(o)}}function u(){function e(e,t,r,o){return this.actions={goToUpdate:e,goToCreate:e,goToList:e,read:e,"delete":t,update:r,create:o},{action:function(e,t){this.actions[e.definition.data.propertyValue("rel")](e,t)}.bind(this)}}var t={actions:{},$get:e};return e.$inject=["grid-action-goTo","grid-action-delete","grid-action-update","grid-action-create"],t}function l(e,t){return function(r,o){function n(){t.getFormInfo(function(e){o.schema=e.schema,o.form=e.form,o.model=e.model,o.alerts.push({type:"success",msg:t.getMessage("successUpdated")})})}function a(e){o.alerts.push({type:"danger",msg:e.statusText||t.getMessage("serverError")})}var i={method:r.method,url:r.href,data:o.model};return o.$broadcast("schemaFormValidate"),o.scopeForm.gridForm.$valid?void e(i).then(n,a):!1}}function d(){function e(e,t,r){e.alerts=[],e.scopeForm={gridForm:{}},e.setFormScope=function(t){e.scopeForm=t},t.getFormInfo(function(t){e.schema=t.schema,e.form=t.form,e.model=t.model,e.links=t.links,e.$digest()}),e.edit=function(t,o){r.action(o.link,e)},e.go=function(t){r.action(t,e)},e.closeAlert=function(t){e.alerts.splice(t,1)}}var t={restrict:"E",replace:!0,controller:e};return e.$inject=["$scope","grid-entity","grid-actions"],t}function f(e,t){function r(r){r.alerts=[],e.getTableInfo(function(e){r.rows=e.rows,r.columns=e.columns,r.links=e.links,r.$digest()}),r.edit=function(e){t.action(e,r)},r.closeAlert=function(e){r.alerts.splice(e,1)}}var o={restrict:"E",controller:r};return r.$inject=["$scope"],o}function p(){function e(e,t){e.getTemplateUrl=function(){return e.gridModel.params.type?"templates/grid/form.html":"templates/grid/table.html"},t.setModel(e.gridModel)}var t={restrict:"E",template:'<ng-include src="getTemplateUrl()" />',scope:{gridModel:"=gridModel"},controller:e,link:function(e,t,r,o){}};return e.$inject=["$scope","grid-entity"],t}var m=[];try{e.module("schemaForm"),m.push("schemaForm")}catch(g){}try{e.module("ui.bootstrap"),m.push("ui.bootstrap")}catch(g){}var h=e.module("grid",m);return e.module("grid").run(["$templateCache",function(e){e.put("templates/grid/table.html",'<grid-table><span ng-repeat="link in links"><a href="javascript:void(0);" ng-click="edit(link)">{{link.title}}</a> </span><alert ng-repeat="alert in alerts" type="{{alert.type}}" close="closeAlert($index)">{{alert.msg}}</alert><table class="table grid"><thead><tr><th ng-repeat="column in columns">{{column.title}}</th></tr></thead><tbody><tr ng-repeat="row in rows"><td ng-repeat="column in columns"><span ng-if="column.attributeName !== \'links\'">{{row[column.attributeName]}}</span><span ng-if="column.attributeName == \'links\'"><span ng-repeat="link in row.links"><a href="javascript:void(0);" ng-click="edit(link)">{{link.title}}</a> </span></span></td></tr></tbody></table></grid-table>'),e.put("templates/grid/form.html",'<grid-form><span ng-repeat="link in links"><a href="javascript:void(0);" ng-click="go(link)">{{link.title}}</a> </span><div><alert ng-repeat="alert in alerts" type="{{alert.type}}" close="closeAlert($index)">{{alert.msg}}</alert></div><form novalidate name="gridForm" ng-init="setFormScope(this)"sf-schema="schema" sf-form="form" sf-model="model"class="form-horizontal" role="form" ng-if="hideForm !== true"></form></grid-form>')}]),e.module("grid").factory("_",function(){return n}),e.module("grid").provider("grid-entity",a),Object.byString=function(e,t){t=t.replace(/\[(\w+)]/g,".$1"),t=t.replace(/\/(\w+)/g,".$1"),t=t.replace(/^\./,"");for(var r=t.split("."),o=0,n=r.length;n>o;++o){var a=r[o];if(!(a in e))return;e=e[a]}return e},e.module("grid").factory("grid-action-create",i),i.$inject=["$http","grid-entity"],e.module("grid").factory("grid-action-delete",c),c.$inject=["$http","grid-entity"],e.module("grid").factory("grid-action-goTo",s),s.$inject=["$location"],e.module("grid").provider("grid-actions",u),u.$inject=[],e.module("grid").factory("grid-action-update",l),l.$inject=["$http","grid-entity"],e.module("grid").directive("gridForm",d),e.module("grid").directive("gridTable",f),f.$inject=["grid-entity","grid-actions"],e.module("grid").directive("vmsGrid",p),h});