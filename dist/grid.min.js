!function(e,t){"function"==typeof define&&define.amd?define(["angular","jsonary","angular-bootstrap","bootstrap-decorator","lodash"],t):"object"==typeof exports?module.exports=t(require("angular"),require("Jsonary"),require("angularBootstrap"),require("bootstrapDecorator"),require("lodash")):e.vmsGrid=t(e.angular,e.Jsonary,e.angularBootstrap,e.bootstrapDecorator,e._)}(this,function(e,t,r,a,o){function n(t,r,a,o){function n(){this.form=[],this.model={},this.schema={},this.links={}}function i(){var e=this;return{form:e.form,model:e.model,schema:e.schema,links:e.links}}function s(e){function t(t,r){var a=t.property("data").property("attributes"),i=n.mergeRelSchema(a.schemas()[0].data.value(),r);n.type=n.TYPE_FORM,n._getFieldsForm(t,function(r,a){function s(r){n.form=r,n.form=o.union(n.form,n._getFormButtonBySchema(t.property("data").links())),void 0!==e&&e(n.getConfig())}n.links=t.links(),n.schema=i,n.model=n._fieldsToFormFormat(r),n._getFormConfig(t,s)})}var a,n=this,i=n.getModel();a=n.getResourceUrl(i.url,i.params),r(function(){n.fetchData(a,t)})}function c(e){var t=e.own,r=t.property("attributes").value();return o.forEach(e.relationships,function(e,a){r[a]=o.map(e,function(e){return e.property("data").propertyValue("id")}),Array.isArray(t.property("relationships").property(a).propertyValue("data"))||(r[a]=r[a][0])}),r}function u(e,t){var a=this,n=[];a._createTitleMap(e.property("data"),function(i){var s=a.mergeRelSchema(e.property("data").schemas()[0].data.value(),e.schemas()[0].data.document.raw.value()).properties.attributes.properties;o.forEach(s,function(e,t){var r={key:t};i[t]&&(r.titleMap=i[t]),n.push(r)}),r(function(){t(n)})})}function l(e,t){function r(e){var r={own:a,relationships:o.mapValues(e[0],function(e){return o.forEach(e,function(t,r){e[r]=t.data}),e})};t(r)}var a,n=this,i=[];a=e.property("data"),i.push(n._getRelationResource(e.property("data"))),n._batchLoadData(i,r)}function d(e){var t=this,r=[],a=e.property("relationships"),n=e.property("attributes"),i=a.value(),s=(n.value(),e.schemas()[0].data.document.raw.value());return o.forEach(i,function(e,i){var c=e.links.self,u=a.property(i).schemas()[0].data.propertyValue("name"),l=t._replaceFromFull(n.schemas()[0].data.value(),s).properties[i],d={};l.items&&l.items["enum"]?d=l.items["enum"]:l["enum"]&&(d=l["enum"]),o.forEach(d,function(e){var a=t.getResourceUrl(c,{type:t["default"].actionGetResource,id:e});r.push({url:a,enumItem:e,relationName:i,attributeName:u})})}),r}function p(e,t){var r=this,a=r._getTitleMapsForRelations(e);r.fetchCollection(o.map(a,"url"),function(e){var r={};o.forEach(a,function(t){r[t.relationName]||(r[t.relationName]=[]),r[t.relationName].push({value:t.enumItem,name:e[t.url].data.property("data").property("attributes").propertyValue(t.attributeName)||t.enumItem})}),t(r)})}function f(e,t){function r(e){var t=e;return o.forEach(t,function(e,r){if(e.type)switch(e.type){case"object":t[r]={};break;case"string":t[r]="";break;case"array":t[r]=[];break;case"integer":t[r]=""}}),t}var a,n=this,i=n.mergeRelSchema(e,t);return a=o.clone(i.properties),a.data=r(o.clone(i.properties.data.properties)),a.data.attributes=r(o.clone(i.properties.data.properties.attributes.properties)),a}function m(e){var t=[];return o.forEach(e,function(e){t.push({type:"button",title:e.title,link:e,onClick:"edit($event, form)"})}),t}return e.extend(n.prototype,{getFormInfo:s,getConfig:i,_getTitleMapsForRelations:d,_createTitleMap:p,_getFormConfig:u,_getFieldsForm:l,_fieldsToFormFormat:c,_getEmptyData:f,_getFormButtonBySchema:m},t),n}function i(t,r,a,o){function n(){this.rows=[],this.columns={},this.schema={},this.links={}}function i(){var e=this;return{rows:e.rows,columns:e.columns,schema:e.schema,links:e.links}}function s(e){function t(t,r){var a=o.mergeRelSchema(t.schemas()[0].data.value(),r);o.type=o.TYPE_TABLE,o._getRowsByData(t,function(r){o.rows=o.rowsToTableFormat(r),o.links=t.links(),o.columns=o.getColumnsBySchema(a),o.columns.push({title:"Actions",type:"string",attributeName:"links"}),void 0!==e&&e(o.getConfig())})}var a,o=this,n=o.getModel();a=o.getResourceUrl(n.url,n.params),r(function(){o.fetchData(a,t)})}function c(e){var t=[],r=e.properties.data.items.properties.attributes.properties;return o.forEach(r,function(e,r){e.attributeName=r,t.push(e)}),t}function u(e){var t=[];return o.forEach(e,function(e){var r=e.own,a=r.property("attributes").value();o.forEach(e.relationships,function(t,r){a[r]=o.map(t,function(t){var a=e.own.property("relationships").property(r).schemas()[0].data.propertyValue("name");return a?t.property("data").property("attributes").propertyValue(a):t.property("data").propertyValue("id")}).join(", ")}),a.links=[],o.forOwn(r.links(),function(e){a.links.push(e)}),t.push(a)}),t}function l(e,t){function r(e){var r=[];o.forEach(n,function(t,a){var n={own:t,relationships:o.mapValues(e[a],function(e){return o.forEach(e,function(t,r){e[r]=t.data}),e})};r.push(n)}),t(r)}var a=this,n=[],i=[];e.property("data").items(function(e,t){i.push(a._getRelationResource(t)),n.push(t)}),a._batchLoadData(i,r)}return e.extend(n.prototype,{getConfig:i,getTableInfo:s,getColumnsBySchema:c,rowsToTableFormat:u,_getRowsByData:l},t),n}function s(){function e(e,r,a){function o(e){b=e}function n(){return b}function i(e){return k[e]}function s(e,t){k[e]=t}function c(e,t){var r=e;return t.resource&&(r=e+"/"+t.resource),t.type&&("update"===t.type||"read"===t.type?r+="/"+t.type+"/"+t.id:"create"===t.type&&(r+="/schema#/definitions/create")),r}function u(e,r){return void 0===b?(alert("Please set model before call fetch data"),!1):void t.getData(e,function(e,t){var a=e,o=e.property("data").schemas()[0].data.document.raw.value();void 0!==r&&r(a,o,t)})}function l(e,r){var a=this;t.getSchema(e,function(e){var o=e.data.document.raw.value(),n=t.create(a._getEmptyData(e.data.value(),o));n.document.url=a.getModel().url,n.addSchema(e),void 0!==r&&r(n,o)})}function d(e,t){function r(e,r){void 0!==t&&t(e,r)}var a=this;"create"===b.params.type?a.loadSchema(e,r):a.loadData(e,r)}function p(e,t){var o,n=this,i=0,s=0,c={};o=a.uniq(e),a.forEach(o,function(e){n.loadData(e,function(t,r,a){c[e]={data:t,schema:r,request:a},i++}),s++});var u=r(function(){s===i&&(r.cancel(u),void 0!==t&&t(c))},100)}function f(e,t){var r=e;return r=m(r,t)}function m(e,t){for(var r in e)e.hasOwnProperty(r)&&("object"==typeof e[r]&&!Array.isArray(e[r])&&e[r].$ref&&(e[r]=Object.byString(t,e[r].$ref.substring(2)),m(e[r],t)),"object"!=typeof e[r]||Array.isArray(e[r])||"links"===e[r]||m(e[r],t));return e}function g(e){var t,r=this,o={};return(t=e.property("relationships").value())&&a.forEach(t,function(e,t){o[t]=r._getRelationLink(e)}),o}function h(e){var t=this,r=[];if(Array.isArray(e.data)){var o=[];a.forEach(e.data,function(r){o.push({url:t.getResourceUrl(e.links.self,{type:t["default"].actionGetResource,id:r.id})})}),r=o}else r=[{url:t.getResourceUrl(e.links.self,{type:t["default"].actionGetResource,id:e.data.id})}];return r}function y(e){var t=[];return a.forEach(e,function(e){a.forEach(e,function(e){a.forEach(e,function(e){t.push(e.url)})})}),t}function v(e,t){var r=this;r.fetchCollection(y(e),function(r){var o=[];a.forEach(e,function(e,t){a.forEach(e,function(e,n){a.forEach(e,function(e,a){o[t]=o[t]||{},o[t][n]=o[t][n]||[],o[t][n][a]=r[e.url]})})}),t(o)})}var b,k={successDeleted:"Successfully delete",successCreated:"Successfully create",successUpdated:"Successfully update",serverError:"Oops! server error"};return{"default":{actionGetResource:"read"},TYPE_FORM:"form",TYPE_TABLE:"table",type:"",config:{},setModel:o,getModel:n,setMessage:s,getMessage:i,fetchData:d,fetchCollection:p,loadData:u,loadSchema:l,getResourceUrl:c,mergeRelSchema:f,_getRelationResource:g,_replaceFromFull:m,_getRelationLink:h,_batchLoadData:v}}var r={$get:e};return e.$inject=["$timeout","$interval","_"],r}function c(e,t){return function(t,r,a){function o(){t.getFormInfo(function(e){a.schema=e.schema,a.form=e.form,a.model=e.model,a.alerts.push({type:"success",msg:t.getMessage("successCreated")})})}function n(e){a.alerts.push({type:"danger",msg:e.statusText||t.getMessage("serverError")})}var i={method:r.method,url:r.href,data:a.model};return a.$broadcast("schemaFormValidate"),a.scopeForm.gridForm.$valid?void e(i).then(o,n):!1}}function u(e,t){return function(t,r,a){function o(){t.type===t.TYPE_TABLE?t.getTableInfo(function(e){a.rows=e.rows,a.columns=e.columns,a.links=e.links}):t.type===t.TYPE_FORM&&(a.hideForm=!0),a.alerts.push({type:"success",msg:t.getMessage("successDeleted")})}function n(e){a.alerts.push({type:"danger",msg:e.statusText||t.getMessage("serverError")})}var i={method:r.method,url:r.href};e(i).then(o,n)}}function l(e){return function(t,r){var a=r.definition.data.propertyValue("href"),o=a.replace(/{([^\{,}]*)}/g,function(e,t){return r.subjectData.propertyValue(t)});e.url(o)}}function d(){function e(e,t,r,a){return this.actions={goToUpdate:e,goToCreate:e,goToList:e,read:e,"delete":t,update:r,create:a},{action:function(e,t,r){this.actions[t.definition.data.propertyValue("rel")](e,t,r)}.bind(this)}}var t={actions:{},$get:e};return e.$inject=["grid-action-goTo","grid-action-delete","grid-action-update","grid-action-create"],t}function p(e,t){return function(t,r,a){function o(){t.getFormInfo(function(e){a.schema=e.schema,a.form=e.form,a.model=e.model,a.alerts.push({type:"success",msg:t.getMessage("successUpdated")})})}function n(e){a.alerts.push({type:"danger",msg:e.statusText||t.getMessage("serverError")})}var i={method:r.method,url:r.href,data:a.model};return a.$broadcast("schemaFormValidate"),a.scopeForm.gridForm.$valid?void e(i).then(o,n):!1}}function f(){function e(e,t,r,a){e.alerts=[],e.scopeForm={gridForm:{}},e.setFormScope=function(t){e.scopeForm=t};var o=new r;o.getFormInfo(function(t){e.schema=t.schema,e.form=t.form,e.model=t.model,e.links=t.links,e.$digest()}),e.edit=function(t,r){a.action(o,r.link,e)},e.go=function(t){a.action(o,t,e)},e.closeAlert=function(t){e.alerts.splice(t,1)}}var t={restrict:"E",replace:!0,controller:e};return e.$inject=["$scope","grid-entity","gridForm","grid-actions"],t}function m(e,t,r){function a(e){e.alerts=[];var a=new t;a.getTableInfo(function(t){e.rows=t.rows,e.columns=t.columns,e.links=t.links}),e.edit=function(t){r.action(a,t,e)},e.closeAlert=function(t){e.alerts.splice(t,1)}}var o={restrict:"E",controller:a};return a.$inject=["$scope"],o}function g(){function e(e,t){e.getTemplateUrl=function(){return e.gridModel.params.type?"templates/grid/form.html":"templates/grid/table.html"},t.setModel(e.gridModel)}var t={restrict:"E",template:'<ng-include src="getTemplateUrl()" />',scope:{gridModel:"=gridModel"},controller:e,link:function(e,t,r,a){}};return e.$inject=["$scope","grid-entity"],t}var h=[];try{e.module("schemaForm"),h.push("schemaForm")}catch(y){}try{e.module("ui.bootstrap"),h.push("ui.bootstrap")}catch(y){}var v=e.module("grid",h);return e.module("grid").factory("_",function(){return o}),e.module("grid").factory("gridForm",n),n.$inject=["grid-entity","$timeout","$interval","_"],e.module("grid").factory("gridTable",i),i.$inject=["grid-entity","$timeout","$interval","_"],e.module("grid").provider("grid-entity",s),Object.byString=function(e,t){t=t.replace(/\[(\w+)]/g,".$1"),t=t.replace(/\/(\w+)/g,".$1"),t=t.replace(/^\./,"");for(var r=t.split("."),a=0,o=r.length;o>a;++a){var n=r[a];if(!(n in e))return;e=e[n]}return e},e.module("grid").factory("grid-action-create",c),c.$inject=["$http","grid-entity"],e.module("grid").factory("grid-action-delete",u),u.$inject=["$http","grid-entity"],e.module("grid").factory("grid-action-goTo",l),l.$inject=["$location"],e.module("grid").provider("grid-actions",d),d.$inject=[],e.module("grid").factory("grid-action-update",p),p.$inject=["$http","grid-entity"],e.module("grid").run(["$templateCache",function(e){e.put("templates/grid/form.html",'<grid-form><span ng-repeat="link in links"><a href="javascript:void(0);" ng-click="go(link)">{{link.title}}</a> </span><div><alert ng-repeat="alert in alerts" type="{{alert.type}}" close="closeAlert($index)">{{alert.msg}}</alert></div><form novalidate name="gridForm" ng-init="setFormScope(this)"sf-schema="schema" sf-form="form" sf-model="model"class="form-horizontal" role="form" ng-if="hideForm !== true"></form></grid-form>')}]),e.module("grid").directive("gridForm",f),e.module("grid").run(["$templateCache",function(e){e.put("templates/grid/table.html",'<grid-table><span ng-repeat="link in links"><a href="javascript:void(0);" ng-click="edit(link)">{{link.title}}</a> </span><alert ng-repeat="alert in alerts" type="{{alert.type}}" close="closeAlert($index)">{{alert.msg}}</alert><table class="table grid"><thead><tr><th ng-repeat="column in columns">{{column.title}}</th></tr></thead><tbody><tr ng-repeat="row in rows"><td ng-repeat="column in columns"><span ng-if="column.attributeName !== \'links\'">{{row[column.attributeName]}}</span><span ng-if="column.attributeName == \'links\'"><span ng-repeat="link in row.links"><a href="javascript:void(0);" ng-click="edit(link)">{{link.title}}</a> </span></span></td></tr></tbody></table></grid-table>')}]),e.module("grid").directive("gridTable",m),m.$inject=["grid-entity","gridTable","grid-actions"],e.module("grid").directive("vmsGrid",g),v});