!function(t,e){"function"==typeof define&&define.amd?define(["angular","jsonary","angular-bootstrap","bootstrap-decorator","lodash"],e):"object"==typeof exports?module.exports=e(require("angular"),require("Jsonary"),require("angularBootstrap"),require("bootstrapDecorator"),require("lodash")):t.vmsGrid=e(t.angular,t.Jsonary,t.angularBootstrap,t.bootstrapDecorator,t._)}(this,function(t,e,r,a,o){function n(){function t(t,r,a){function o(t){A=t}function n(){return A}function i(t){return V[t]}function c(t,e){V[t]=e}function s(t,e){function r(t,r){void 0!==e&&e(t,r)}var a=this;"create"===A.params.type?a.loadSchema(t,r):a.loadData(t,r)}function u(t,r){return void 0===A?(alert("Please set model before call fetch data"),!1):void e.getData(t,function(t,e){var a=t,o=t.property("data").schemas()[0].data.document.raw.value();void 0!==r&&r(a,o,e)})}function l(t,r){var a=this;e.getSchema(t,function(t){var o=t.data.document.raw.value(),n=e.create(a._getEmptyData(t.data.value(),o));n.document.url=a.getModel().url,n.addSchema(t),void 0!==r&&r(n,o)})}function f(t,e){function r(t){var e=t;return a.forEach(e,function(t,r){if(t.type)switch(t.type){case"object":e[r]={};break;case"string":e[r]="";break;case"array":e[r]=[];break;case"integer":e[r]=""}}),e}var o,n=E(t,e);return o=a.clone(n.properties),o.data=r(a.clone(n.properties.data.properties)),o.data.attributes=r(a.clone(n.properties.data.properties.attributes.properties)),o}function p(t,e){var r=t;return e.resource&&(r=t+"/"+e.resource),e.type&&("update"===e.type||"read"===e.type?r+="/"+e.type+"/"+e.id:"create"===e.type&&(r+="/schema#/definitions/create")),r}function d(e){function r(t,r){var a=E(t.schemas()[0].data.value(),r);o.type=o.TYPE_TABLE,o.config.table||(o.config.table={}),o._getRowsByData(t,function(r,n){o.config.table.rows=_(r),o.config.table.links=t.links(),o.config.table.columns=F(a),o.config.table.columns.push({title:"Actions",type:"string",attributeName:"links"}),void 0!==e&&e(o.config.table)})}var a,o=this,n=o.getModel();a=p(n.url,n.params),t(function(){o.fetchData(a,r)})}function m(e){function r(t,r){var o=t.property("data").property("attributes"),i=E(o.schemas()[0].data.value(),r);n.type=n.TYPE_FORM,n.config.form||(n.config.form={}),n._getFieldsForm(t,function(r,o){function c(r){n.config.form.form=r,n.config.form.form=a.union(n.config.form.form,R(t.property("data").links())),void 0!==e&&e(n.config.form)}n.config.form.links=t.links(),n.config.form.schema=i,n.config.form.model=$(r),n._getFormConfig(t,c)})}var o,n=this,i=n.getModel();o=p(i.url,i.params),t(function(){n.fetchData(o,r)})}function g(e,r){var o=this,n=[];o._createTitleMap(e.property("data"),function(o){var i=E(e.property("data").schemas()[0].data.value(),e.schemas()[0].data.document.raw.value()).properties.attributes.properties;a.forEach(i,function(t,e){var r={key:e};o[e]&&(r.titleMap=o[e]),n.push(r)}),t(function(){r(n)})})}function h(t,e){function r(t){var r={own:o,relationships:a.mapValues(t[0],function(t){return a.forEach(t,function(e,r){t[r]=e.data}),t})};e(r)}var o,n=this,i=[];o=t.property("data"),i.push(n._getRelationResource(t.property("data"))),n._batchLoadData(i,r)}function y(t){var e=this,r=[],o=t.property("relationships"),n=t.property("attributes"),i=o.value(),c=(n.value(),t.schemas()[0].data.document.raw.value());return a.forEach(i,function(t,i){var s=t.links.self,u=o.property(i).schemas()[0].data.propertyValue("name"),l=e._replaceFromFull(n.schemas()[0].data.value(),c).properties[i],f={};l.items&&l.items["enum"]?f=l.items["enum"]:l["enum"]&&(f=l["enum"]),a.forEach(f,function(t){var a=s+"/"+e["default"].actionGetResource+"/"+t;r.push({url:a,enumItem:t,relationName:i,attributeName:u})})}),r}function v(t,e){var r=this,o=r.getTitleMapsForRelations(t);r.fetchCollection(a.map(o,"url"),function(t){var r={};a.forEach(o,function(e){r[e.relationName]||(r[e.relationName]=[]),r[e.relationName].push({value:e.enumItem,name:t[e.url].data.property("data").property("attributes").propertyValue(e.attributeName)||e.enumItem})}),e(r)})}function b(t,e){var o,n=this,i=0,c=0,s={};o=a.uniq(t),a.forEach(o,function(t){n.loadData(t,function(e,r,a){s[t]={data:e,schema:r,request:a},i++}),c++});var u=r(function(){c===i&&(r.cancel(u),void 0!==e&&e(s))},100)}function k(t,e){for(var r in t)t.hasOwnProperty(r)&&("object"==typeof t[r]&&!Array.isArray(t[r])&&t[r].$ref&&(t[r]=Object.byString(e,t[r].$ref.substring(2)),k(t[r],e)),"object"!=typeof t[r]||Array.isArray(t[r])||"links"===t[r]||k(t[r],e));return t}function E(t,e){var r=t;return r=k(r,e)}function F(t){var e=[],r=t.properties.data.items.properties.attributes.properties;return a.forEach(r,function(t,r){t.attributeName=r,e.push(t)}),e}function $(t){var e=t.own,r=e.property("attributes").value();return a.forEach(t.relationships,function(t,o){r[o]=a.map(t,function(t){return t.property("data").propertyValue("id")}),Array.isArray(e.property("relationships").property(o).propertyValue("data"))||(r[o]=r[o][0])}),r}function _(t){var e=[];return a.forEach(t,function(t){var r=t.own,o=r.property("attributes").value();a.forEach(t.relationships,function(e,r){o[r]=a.map(e,function(e){var a=t.own.property("relationships").property(r).schemas()[0].data.propertyValue("name");return a?e.property("data").property("attributes").propertyValue(a):e.property("data").propertyValue("id")}).join(", ")}),o.links=[],a.forOwn(r.links(),function(t){o.links.push(t)}),e.push(o)}),e}function T(t,e){function r(t){var r=[];a.forEach(n,function(e,o){var n={own:e,relationships:a.mapValues(t[o],function(t){return a.forEach(t,function(e,r){t[r]=e.data}),t})};r.push(n)}),e(r)}var o=this,n=[],i=[];t.property("data").items(function(t,e){i.push(o._getRelationResource(e)),n.push(e)}),o._batchLoadData(i,r)}function M(t){var e,r=this,o={};return(e=t.property("relationships").value())&&a.forEach(e,function(t,e){o[e]=r._getRelationLink(t)}),o}function w(t){var e=this,r=[];if(Array.isArray(t.data)){var o=[];a.forEach(t.data,function(r){o.push({url:p(t.links.self,{type:e["default"].actionGetResource,id:r.id})})}),r=o}else r=[{url:p(t.links.self,{type:e["default"].actionGetResource,id:t.data.id})}];return r}function j(t){var e=[];return a.forEach(t,function(t){a.forEach(t,function(t){a.forEach(t,function(t){e.push(t.url)})})}),e}function D(t,e){var r=this;r.fetchCollection(j(t),function(r){var o=[];a.forEach(t,function(t,e){a.forEach(t,function(t,n){a.forEach(t,function(t,a){o[e]=o[e]||{},o[e][n]=o[e][n]||[],o[e][n][a]=r[t.url]})})}),e(o)})}function R(t){var e=[];return a.forEach(t,function(t){e.push({type:"button",title:t.title,link:t,onClick:"edit($event, form)"})}),e}var A,V={successDeleted:"Successfully delete",successCreated:"Successfully create",successUpdated:"Successfully update",serverError:"Oops! server error"};return{"default":{actionGetResource:"read"},TYPE_FORM:"form",TYPE_TABLE:"table",type:"",config:{},setModel:o,getModel:n,getMessage:i,setMessage:c,fetchData:s,loadData:u,loadSchema:l,getTableInfo:d,getFormInfo:m,fetchCollection:b,getTitleMapsForRelations:y,_getRelationResource:M,_replaceFromFull:k,_getRelationLink:w,_createTitleMap:v,_getFormConfig:g,_getFieldsForm:h,_getRowsByData:T,_getEmptyData:f,_batchLoadData:D}}var r={$get:t};return t.$inject=["$timeout","$interval","_"],r}function i(t,e){return function(r,a){function o(){e.getFormInfo(function(t){a.schema=t.schema,a.form=t.form,a.model=t.model,a.alerts.push({type:"success",msg:e.getMessage("successCreated")})})}function n(t){a.alerts.push({type:"danger",msg:t.statusText||e.getMessage("serverError")})}var i={method:r.method,url:r.href,data:a.model};return a.$broadcast("schemaFormValidate"),a.scopeForm.gridForm.$valid?void t(i).then(o,n):!1}}function c(t,e){return function(r,a){function o(){e.type===e.TYPE_TABLE?e.getTableInfo(function(t){a.rows=t.rows,a.columns=t.columns,a.links=t.links}):e.type===e.TYPE_FORM&&(a.hideForm=!0),a.alerts.push({type:"success",msg:e.getMessage("successDeleted")})}function n(t){a.alerts.push({type:"danger",msg:t.statusText||e.getMessage("serverError")})}var i={method:r.method,url:r.href};t(i).then(o,n)}}function s(t){return function(e){var r=e.definition.data.propertyValue("href"),a=r.replace(/{([^\{,}]*)}/g,function(t,r){return e.subjectData.propertyValue(r)});t.url(a)}}function u(){function t(t,e,r,a){return this.actions={goToUpdate:t,goToCreate:t,goToList:t,read:t,"delete":e,update:r,create:a},{action:function(t,e){this.actions[t.definition.data.propertyValue("rel")](t,e)}.bind(this)}}var e={actions:{},$get:t};return t.$inject=["grid-action-goTo","grid-action-delete","grid-action-update","grid-action-create"],e}function l(t,e){return function(r,a){function o(){e.getFormInfo(function(t){a.schema=t.schema,a.form=t.form,a.model=t.model,a.alerts.push({type:"success",msg:e.getMessage("successUpdated")})})}function n(t){a.alerts.push({type:"danger",msg:t.statusText||e.getMessage("serverError")})}var i={method:r.method,url:r.href,data:a.model};return a.$broadcast("schemaFormValidate"),a.scopeForm.gridForm.$valid?void t(i).then(o,n):!1}}function f(){function t(t,e,r){t.alerts=[],t.scopeForm={gridForm:{}},t.setFormScope=function(e){t.scopeForm=e},e.getFormInfo(function(e){t.schema=e.schema,t.form=e.form,t.model=e.model,t.links=e.links,t.$digest()}),t.edit=function(e,a){r.action(a.link,t)},t.go=function(e){r.action(e,t)},t.closeAlert=function(e){t.alerts.splice(e,1)}}var e={restrict:"E",replace:!0,controller:t};return t.$inject=["$scope","grid-entity","grid-actions"],e}function p(t,e){function r(r){r.alerts=[],t.getTableInfo(function(t){r.rows=t.rows,r.columns=t.columns,r.links=t.links}),r.edit=function(t){e.action(t,r)},r.closeAlert=function(t){r.alerts.splice(t,1)}}var a={restrict:"E",controller:r};return r.$inject=["$scope"],a}function d(){function t(t,e){t.getTemplateUrl=function(){return t.gridModel.params.type?"templates/grid/form.html":"templates/grid/table.html"},e.setModel(t.gridModel)}var e={restrict:"E",template:'<ng-include src="getTemplateUrl()" />',scope:{gridModel:"=gridModel"},controller:t,link:function(t,e,r,a){}};return t.$inject=["$scope","grid-entity"],e}var m=[];try{t.module("schemaForm"),m.push("schemaForm")}catch(g){}try{t.module("ui.bootstrap"),m.push("ui.bootstrap")}catch(g){}var h=t.module("grid",m);return t.module("grid").run(["$templateCache",function(t){t.put("templates/grid/table.html",'<grid-table><span ng-repeat="link in links"><a href="javascript:void(0);" ng-click="edit(link)">{{link.title}}</a> </span><alert ng-repeat="alert in alerts" type="{{alert.type}}" close="closeAlert($index)">{{alert.msg}}</alert><table class="table grid"><thead><tr><th ng-repeat="column in columns">{{column.title}}</th></tr></thead><tbody><tr ng-repeat="row in rows"><td ng-repeat="column in columns"><span ng-if="column.attributeName !== \'links\'">{{row[column.attributeName]}}</span><span ng-if="column.attributeName == \'links\'"><span ng-repeat="link in row.links"><a href="javascript:void(0);" ng-click="edit(link)">{{link.title}}</a> </span></span></td></tr></tbody></table></grid-table>'),t.put("templates/grid/form.html",'<grid-form><span ng-repeat="link in links"><a href="javascript:void(0);" ng-click="go(link)">{{link.title}}</a> </span><div><alert ng-repeat="alert in alerts" type="{{alert.type}}" close="closeAlert($index)">{{alert.msg}}</alert></div><form novalidate name="gridForm" ng-init="setFormScope(this)"sf-schema="schema" sf-form="form" sf-model="model"class="form-horizontal" role="form" ng-if="hideForm !== true"></form></grid-form>')}]),t.module("grid").factory("_",function(){return o}),t.module("grid").provider("grid-entity",n),Object.byString=function(t,e){e=e.replace(/\[(\w+)]/g,".$1"),e=e.replace(/\/(\w+)/g,".$1"),e=e.replace(/^\./,"");for(var r=e.split("."),a=0,o=r.length;o>a;++a){var n=r[a];if(!(n in t))return;t=t[n]}return t},t.module("grid").factory("grid-action-create",i),i.$inject=["$http","grid-entity"],t.module("grid").factory("grid-action-delete",c),c.$inject=["$http","grid-entity"],t.module("grid").factory("grid-action-goTo",s),s.$inject=["$location"],t.module("grid").provider("grid-actions",u),u.$inject=[],t.module("grid").factory("grid-action-update",l),l.$inject=["$http","grid-entity"],t.module("grid").directive("gridForm",f),t.module("grid").directive("gridTable",p),p.$inject=["grid-entity","grid-actions"],t.module("grid").directive("vmsGrid",d),h});