!function(t,e){"function"==typeof define&&define.amd?define(["angular","jsonary","angular-bootstrap","bootstrap-decorator","lodash"],e):"object"==typeof exports?module.exports=e(require("angular"),require("Jsonary"),require("angularBootstrap"),require("bootstrapDecorator"),require("lodash")):t.vmsGrid=e(t.angular,t.Jsonary,t.angularBootstrap,t.bootstrapDecorator,t._)}(this,function(t,e,r,n,a){function o(e,r,n){function a(t){this.setModel(t),this.form=[],this.model={},this.schema={},this.links={}}function o(){var t=this;return{form:t.form,model:t.model,schema:t.schema,links:t.links}}function i(t){function e(e,r){var a=e.property("data").property("attributes"),i=o.mergeRelSchema(a.schemas()[0].data.value(),r);o._getFieldsForm(e,function(r){function a(r){o.form=r,o.form=n.union(o.form,o._getFormButtonBySchema(e.property("data").links())),void 0!==t&&t(o.getConfig())}o.links=e.links(),o.schema=i,o.model=o._fieldsToFormFormat(r),o._getFormConfig(e,a)})}var a,o=this,i=o.getModel();a=o.getResourceUrl(i.url,i.params),r(function(){o.fetchData(a,e)})}function s(t){var e=t.own,r=e.property("attributes").value();return n.forEach(t.relationships,function(t,a){r[a]=n.map(t,function(t){return t.property("data").propertyValue("id")}),Array.isArray(e.property("relationships").property(a).propertyValue("data"))||(r[a]=r[a][0])}),r}function c(t,e){var a=this,o=[];a._createTitleMap(t.property("data"),function(a){var i=t.schemas().propertySchemas("data").getFull().propertySchemas("attributes").definedProperties();n.forEach(i,function(t){var e={key:t};a[t]&&(e.titleMap=a[t]),o.push(e)}),r(function(){e(o)})})}function u(t,e){function r(t){var r={own:a,relationships:n.mapValues(t[0],function(t){return n.forEach(t,function(e,r){t[r]=e.data}),t})};e(r)}var a,o=this,i=[];a=t.property("data"),i.push(o._getRelationResource(t.property("data"))),o._batchLoadData(i,r)}function l(t){var e=[];return t.property("data").items(function(t,r){e.push(r.propertyValue("id"))}),e}function d(t,e){var r=this,a=[],o=[];t.property("relationships").properties(function(t,e){n.isEmpty(e.links("relation"))||o.push({url:e.links("relation")[0].href,data:e})}),r.fetchCollection(n.map(o,"url"),function(i){n.forEach(o,function(e){var o=e.data,s=i[e.url].data,c=r._getEnumValues(s);console.log(t),n.forEach(c,function(t){var e=r.getResourceUrl(o.links("relation")[0].href,{type:r["default"].actionGetResource,id:t});a.push({url:e,enumItem:t,relationName:o.parentKey(),attributeName:o.schemas().relationField()})})}),e(a)})}function p(t,e){var r=this;r._getTitleMapsForRelations(t,function(t){r.fetchCollection(n.map(t,"url"),function(r){var a={};n.forEach(t,function(t){a[t.relationName]||(a[t.relationName]=[]),a[t.relationName].push({value:t.enumItem,name:r[t.url].data.property("data").property("attributes").propertyValue(t.attributeName)||t.enumItem})}),e(a)})})}function f(t){var e=[];return n.forEach(t,function(t){e.push({type:"button",title:t.title,link:t,onClick:"edit($event, form)"})}),e}return a.prototype=new e,t.extend(a.prototype,{getFormInfo:i,getConfig:o,_getEnumValues:l,_getTitleMapsForRelations:d,_createTitleMap:p,_getFormConfig:c,_getFieldsForm:u,_fieldsToFormFormat:s,_getFormButtonBySchema:f}),a}function i(){function t(t,e){e=e.replace(/\[(\w+)]/g,".$1"),e=e.replace(/\/(\w+)/g,".$1"),e=e.replace(/^\./,"");for(var r=e.split("."),n=0,a=r.length;a>n;++n){var o=r[n];if(!(o in t))return;t=t[o]}return t}function e(t){var e,r=t.indexOf("?");return r>=0&&(e=_.chain(t.slice(t.indexOf("?")+1).split("&")).map(function(t){return t?t.split("="):void 0}).compact().object().value()),e||{}}function r(t,e){var r,n=t.indexOf("?"),a=t;return n>=0&&(a=t.slice(0,n)),r=Object.keys(e).map(function(t){return t+"="+encodeURIComponent(e[t])}).join("&"),r=r?"?"+r:"",a+r}var n={parseLocationSearch:e,setLocationSearch:r,strToObject:t};return n}function s(e,r){function n(){this.pageParam="page",this.currentPage=1,this.perPage=1,this.totalCount=2}function a(){return this.pageParam}function o(t){this.totalCount=t}function i(){return this.totalCount}function s(t){this.perPage=t}function c(){return this.perPage}function u(){var t=this.perPage<1?1:Math.ceil(this.totalCount/this.perPage);return Math.max(t||0,1)}function l(t){this.currentPage=t}function d(){return this.currentPage}function p(){var t;return t=Math.max(this.currentPage||0,1)*this.perPage-this.perPage}function f(t){var r,n;return n=e.parseLocationSearch(t),n[this.pageParam+"[offset]"]=this.getOffset(),n[this.pageParam+"[limit]"]=this.getPerPage(),r=e.setLocationSearch(t,n)}return t.extend(n.prototype,{getPageParam:a,setTotalCount:o,getTotalCount:i,setPerPage:s,getPerPage:c,getPageCount:u,setCurrentPage:l,getCurrentPage:d,getOffset:p,getPageUrl:f}),n}function c(e,r){function n(){this.sortParam="sort"}function a(t){return t?"asc"==t?"desc":"":"asc"}function o(){return this.field?this.field.indexOf(".")>=0?this.field.slice(0,this.field.indexOf(".")):this.field:void 0}function i(t,e){this.field=t,this.direction=e}function s(t){this.sortFields=t}function c(t){var r,n;return this.field?(n=e.parseLocationSearch(t),n[this.sortParam+"["+this.field+"]"]=this.direction,r=e.setLocationSearch(t,n)):t}return n.DIRECTION_ASC="asc",n.DIRECTION_DESC="desc",n.field=void 0,n.direction="",n.sortFields=[],t.extend(n.prototype,{getColumn:o,getDirectionColumn:a,setSortFields:s,setSorting:i,getUrl:c}),n}function u(e,r,n,a,o){function i(t){this.setModel(t),this.pagination=new r,this.sorting=new n,this.rows=[],this.columns={},this.links={}}function s(){var t=this;return{rows:t.rows,columns:t.columns,links:t.links}}function c(t){function e(e,r){n.pagination.setTotalCount(e.property("meta").propertyValue("total")),n._getRowsByData(e,function(r){n.rows=n.rowsToTableFormat(r),n.links=e.links(),n.columns=n.getColumnsBySchema(e),n.sorting.setSortFields(o.map(n.columns,"attributeName")),n.columns.push({title:"Actions",type:"string",attributeName:"links"}),void 0!==t&&t(n.getConfig())})}var r,n=this,i=n.getModel();r=n.pagination.getPageUrl(n.getResourceUrl(i.url,i.params)),r=n.sorting.getUrl(r),a(function(){n.fetchData(r,e)})}function u(t,e){t=this.getSortingParamByField(t),this.sorting.setSorting(t,e)}function l(t){var e=t,r=this.data.property("data").item(0).property("relationships").property(t).schemas().relationField();return r&&(e+="."+r),e}function d(){return this.sorting.direction?this.getSortingParamByField(this.sorting.field)+"_"+this.sorting.direction:null}function p(t){var e=function(t){var e=[];return t.properties(function(t,r){var n=r.schemas()[0].data.value();n.attributeName=t,e.push(n)}),e},r=t.property("data").item(0).property("attributes"),n=t.property("data").item(0).property("relationships");return o.union(e(r),e(n))}function f(t){var e=[];return o.forEach(t,function(t){var r=t.own,n=r.property("attributes").value();o.forEach(t.relationships,function(e,r){n[r]=o.map(e,function(e){var n=t.own.schemas().propertySchemas("relationships").propertySchemas(r).relationField();return n?e.property("data").property("attributes").propertyValue(n):e.property("data").propertyValue("id")}).join(", ")}),n.links=[],o.forOwn(r.links(),function(t){n.links.push(t)}),e.push(n)}),e}function g(t,e){function r(t){var r=[];o.forEach(a,function(e,n){var a={own:e,relationships:o.mapValues(t[n],function(t){return o.forEach(t,function(e,r){t[r]=e.data}),t})};r.push(a)}),e(r)}var n=this,a=[],i=[];t.property("data").items(function(t,e){i.push(n._getRelationResource(e)),a.push(e)}),n._batchLoadData(i,r)}return i.prototype=new e,t.extend(i.prototype,{getConfig:s,getTableInfo:c,getColumnsBySchema:p,rowsToTableFormat:f,getSortingParamByField:l,getSortingParamValue:d,setSorting:u,_getRowsByData:g}),i}function l(){function r(r,n,a){function o(){e.extendData({relationships:function(){return this.propertyValue("relationships")},attributes:function(){return this.propertyValue("attributes")}}),e.extendSchema({relationField:function(){return this.data.propertyValue("relationField")}}),e.extendSchemaList({relationField:function(){var t=null;return this.getFull().each(function(e,r){var n=r.relationField();null!=n&&(null==t||t>n)&&(t=n)}),t}})}function i(t){S=t}function s(){return S}function c(t){return C[t]}function u(t,e){C[t]=e}function l(t,e){var r=t;return e.resource&&(r=t+"/"+e.resource),e.type&&("update"===e.type||"read"===e.type?r+="/"+e.type+"/"+e.id:"create"===e.type&&(r+="/schema#/definitions/create")),r}function d(t,r){e.getData(t,function(t,e){var n=t,a=t.property("data").schemas()[0].data.document.raw.value();void 0!==r&&r(n,a,e)})}function p(t,r){var n=this;e.getSchema(t,function(t){var a=t.data.document.raw.value(),o=e.create(n._getEmptyData(t));o.document.url=n.getModel().url,o.addSchema(t),void 0!==r&&r(o,a)})}function f(t){var e=t;return a.forEach(e,function(t,r){if(t.type)switch(t.type){case"object":e[r]={};break;case"string":e[r]="";break;case"array":e[r]=[];break;case"integer":e[r]=""}}),e}function g(t){var e,r=this;e=t.createValue(),e.data.attributes={};var n=t.propertySchemas("data").getFull().propertySchemas("attributes");return a.forEach(n.definedProperties(),function(t){e.data.attributes[t]=void 0!==n.propertySchemas(t).createValue()?n.propertySchemas(t).createValue():n.propertySchemas(t)[0].defaultValue()}),e.data.relationships=r._getEmptyDataRelations(t),e}function m(t){var e={},r=t.propertySchemas("data").getFull(),n=r.propertySchemas("attributes"),o=r.propertySchemas("relationships");return a.forEach(o.definedProperties(),function(t){var r=n.propertySchemas(t).getFull();e[t]={},e[t].links={},e[t].data="array"==r.basicTypes().toString()?[]:{}}),e}function h(t,e){function r(t,r){n.data=t,void 0!==e&&e(t,r)}var n=this;"create"===S.params.type?n.loadSchema(t,r):n.loadData(t,r)}function y(t,e){var r,o=this,i=0,s=0,c={};r=a.uniq(t),a.forEach(r,function(t){o.loadData(t,function(e,r,n){c[t]={data:e,schema:r,request:n},i++}),s++});var u=n(function(){s===i&&(n.cancel(u),void 0!==e&&e(c))},100)}function v(t,e){var r=t;return r=b(r,e)}function b(t,e){for(var n in t)t.hasOwnProperty(n)&&("object"==typeof t[n]&&!Array.isArray(t[n])&&t[n].$ref?(t[n]=r.strToObject(e,t[n].$ref.substring(2)),b(t[n],e)):"object"==typeof t[n]&&Array.isArray(t[n])&&["oneOf","allOf"].indexOf(n)>=0&&a.forEach(t[n],function(a,o){a.$ref&&(t[n][o]=r.strToObject(e,a.$ref.substring(2)),b(t[n],e))}),"object"!=typeof t[n]||Array.isArray(t[n])||"links"===t[n]||b(t[n],e));return t}function P(t){var e,r=this,n={};return(e=t.property("relationships").value())&&a.forEach(e,function(t,e){n[e]=r._getRelationLink(t)}),n}function F(t){var e=this,r=[];if(Array.isArray(t.data)){var n=[];a.forEach(t.data,function(r){n.push({url:e.getResourceUrl(t.links.self,{type:e["default"].actionGetResource,id:r.id})})}),r=n}else r=a.isEmpty(t.links)||a.isEmpty(t.data)?[]:[{url:e.getResourceUrl(t.links.self,{type:e["default"].actionGetResource,id:t.data.id})}];return r}function k(t){var e=[];return a.forEach(t,function(t){a.forEach(t,function(t){a.forEach(t,function(t){e.push(t.url)})})}),e}function $(t,e){var r=this;r.fetchCollection(k(t),function(r){var n=[];a.forEach(t,function(t,e){n[e]=n[e]||{},a.forEach(t,function(t,o){n[e][o]=n[e][o]||[],a.forEach(t,function(t,a){n[e][o][a]=r[t.url]})})}),e(n)})}var S,C={successDeleted:"Successfully delete",successCreated:"Successfully create",successUpdated:"Successfully update",serverError:"Oops! server error"};return this.data={},t.extend(o.prototype,{"default":{actionGetResource:"read"},config:{},setModel:i,getModel:s,setMessage:u,getMessage:c,fetchData:h,fetchCollection:y,loadData:d,loadSchema:p,getResourceUrl:l,mergeRelSchema:v,getTypeProperty:f,_getEmptyData:g,_getEmptyDataRelations:m,_getRelationResource:P,_replaceFromFull:b,_getRelationLink:F,_batchLoadData:$}),o}var n={$get:r};return r.$inject=["Helper","$interval","_"],n}function d(t){return function(e,r,n){function a(){e.getFormInfo(function(t){n.schema=t.schema,n.form=t.form,n.model=t.model,n.alerts.push({type:"success",msg:e.getMessage("successCreated")})})}function o(t){n.alerts.push({type:"danger",msg:t.statusText||e.getMessage("serverError")})}var i={method:r.method,url:r.href,data:n.model};return n.$broadcast("schemaFormValidate"),n.scopeForm.gridForm.$valid?void t(i).then(a,o):!1}}function p(t,e,r){return function(n,a,o){function i(){n instanceof e?n.getTableInfo(function(t){o.rows=t.rows,o.columns=t.columns,o.links=t.links}):n instanceof r&&(o.hideForm=!0),o.alerts.push({type:"success",msg:n.getMessage("successDeleted")})}function s(t){o.alerts.push({type:"danger",msg:t.statusText||n.getMessage("serverError")})}var c={method:a.method,url:a.href};t(c).then(i,s)}}function f(t){return function(e,r){var n=r.definition.data.propertyValue("href"),a=n.replace(/{([^\{,}]*)}/g,function(t,e){return r.subjectData.propertyValue(e)});t.url(a)}}function g(){function t(t,e,r,n){return this.actions={goToUpdate:t,goToCreate:t,goToList:t,read:t,"delete":e,update:r,create:n},{action:function(t,e,r){this.actions[e.definition.data.propertyValue("rel")](t,e,r)}.bind(this)}}var e={actions:{},$get:t};return t.$inject=["grid-action-goTo","grid-action-delete","grid-action-update","grid-action-create"],e}function m(t,e){return function(e,r,n){function a(){e.getFormInfo(function(t){n.schema=t.schema,n.form=t.form,n.model=t.model,n.alerts.push({type:"success",msg:e.getMessage("successUpdated")})})}function o(t){n.alerts.push({type:"danger",msg:t.statusText||e.getMessage("serverError")})}var i={method:r.method,url:r.href,data:n.model};return n.$broadcast("schemaFormValidate"),n.scopeForm.gridForm.$valid?void t(i).then(a,o):!1}}function h(){function t(t,e,r){t.alerts=[],t.scopeForm={gridForm:{}},t.setFormScope=function(e){t.scopeForm=e};var n=new e(t.gridModel);n.getFormInfo(function(e){t.schema=e.schema,t.form=e.form,t.model=e.model,t.links=e.links,t.$digest()}),t.edit=function(e,a){r.action(n,a.link,t)},t.go=function(e){r.action(n,e,t)},t.closeAlert=function(e){t.alerts.splice(e,1)}}var e={restrict:"E",replace:!0,controller:t};return t.$inject=["$scope","gridForm","grid-actions"],e}function y(t,e){function r(r,n){var a=new t(n.gridModel);n.alerts=[],n.tableInst=a,r(function(){n.$broadcast("onBeforeLoadData"),a.getTableInfo(function(t){n.rows=t.rows,n.columns=t.columns,n.links=t.links,n.$broadcast("onLoadData")})}),n.edit=function(t){e.action(a,t,n)},n.closeAlert=function(t){n.alerts.splice(t,1)}}var n={restrict:"E",controller:r};return r.$inject=["$timeout","$scope"],n}function v(){function t(t,e){var r=t.tableInst.pagination;t.$on("onBeforeLoadData",function(){r.setCurrentPage(e.search().page)}),t.$on("onLoadData",function(){t.show=!0,t.setPagination()}),t.setPagination=function(){t.totalItems=r.getTotalCount(),t.currentPage=r.getCurrentPage(),t.itemsPerPage=r.getPerPage()},t.pageChanged=function(n){r.setCurrentPage(n),t.currentPage=r.getCurrentPage(),e.search("page",n)}}var e={scope:{tableInst:"=table"},require:"^gridTable",templateUrl:"templates/grid/table-pagination.html",restrict:"A",controller:t};return t.$inject=["$scope","$location"],e}function b(){function t(t,e){function r(e){var r=t.tableInst.sorting;if(!e[r.sortParam])return!1;var n=e[r.sortParam].lastIndexOf("_"),a=e[r.sortParam].slice(0,n),o=e[r.sortParam].slice(n+1);r.setSorting(a,o)}var n=t.tableInst.sorting;t.$on("onBeforeLoadData",function(){console.log("sorting before load"),r(e.search())}),t.$on("onLoadData",function(){t.columns=t.tableInst.columns,t.sortFields=n.sortFields,t.setSorting()}),t.setSorting=function(){var t=n.getColumn();t&&(_.where(this.columns,{attributeName:t})[0].sorting=n.direction)},t.sortBy=function(r){var a;r.sorting=a=n.getDirectionColumn(r.sorting),t.tableInst.setSorting(r.attributeName,a),e.search("sort",t.tableInst.getSortingParamValue())}}var e={scope:{tableInst:"=table"},require:"^gridTable",templateUrl:"templates/grid/table-head.html",restrict:"A",controller:t,link:function(t,e,r){}};return t.$inject=["$scope","$location"],e}function P(){function t(t){t.getTemplateUrl=function(){return t.gridModel.params.type?"templates/grid/form.html":"templates/grid/table.html"}}var e={restrict:"E",template:'<ng-include src="getTemplateUrl()" />',scope:{gridModel:"=gridModel"},controller:t,link:function(t,e,r,n){}};return t.$inject=["$scope"],e}var F=[];try{t.module("schemaForm"),F.push("schemaForm")}catch(k){}try{t.module("ui.bootstrap"),F.push("ui.bootstrap")}catch(k){}var $=t.module("grid",F);return t.module("grid").factory("_",function(){return a}),t.module("grid").factory("gridForm",o),o.$inject=["grid-entity","$timeout","_"],t.module("grid").factory("Helper",i),i.$inject=["_"],t.module("grid").factory("gridPagination",s),s.$inject=["Helper","_"],t.module("grid").factory("Sorting",c),c.$inject=["Helper","_"],t.module("grid").factory("gridTable",u),u.$inject=["grid-entity","gridPagination","Sorting","$timeout","_"],t.module("grid").provider("grid-entity",l),t.module("grid").factory("grid-action-create",d),d.$inject=["$http"],t.module("grid").factory("grid-action-delete",p),p.$inject=["$http","gridTable","gridForm"],t.module("grid").factory("grid-action-goTo",f),f.$inject=["$location"],t.module("grid").provider("grid-actions",g),g.$inject=[],t.module("grid").factory("grid-action-update",m),m.$inject=["$http","grid-entity"],t.module("grid").directive("gridForm",h),t.module("grid").directive("gridTable",y),y.$inject=["gridTable","grid-actions"],t.module("grid").directive("tablePagination",v),v.$inject=[],t.module("grid").directive("tableThead",b),b.$inject=[],t.module("grid").directive("vmsGrid",P),t.module("grid").run(["$templateCache",function(t){t.put("templates/grid/form.html",'<grid-form>\n    <span ng-repeat="link in links">\n    <a href="javascript:void(0);" ng-click="go(link)">{{link.title}}</a>\n    </span>\n\n    <div>\n        <alert ng-repeat="alert in alerts" type="{{alert.type}}" close="closeAlert($index)">{{alert.msg}}</alert>\n    </div>\n    <form novalidate name="gridForm" ng-init="setFormScope(this)"\n          sf-schema="schema" sf-form="form" sf-model="model"\n          class="form-horizontal" role="form" ng-if="hideForm !== true">\n    </form>\n</grid-form>'),t.put("templates/grid/table-head.html",'<tr>\n    <th ng-repeat="column in columns">\n        <div ng-if="sortFields.indexOf(column.attributeName)>=0" class="th-inner sortable" ng-click="sortBy(column, $event)">{{column.title}}\n            <span ng-if="column.sorting" class="order" ng-class="{\'dropup\': column.sorting==\'desc\'}">\n                <span class="caret" style="margin: 0px 5px;"></span>\n            </span>\n        </div>\n        <div ng-if="sortFields.indexOf(column.attributeName)<0" class="th-inner">{{column.title}}</div>\n    </th>\n</tr>\n'),t.put("templates/grid/table-pagination.html",'<pagination ng-if="show" direction-links="false" boundary-links="true" items-per-page="itemsPerPage" total-items="totalItems" ng-model="currentPage" ng-change="pageChanged(currentPage)"></pagination>\n'),t.put("templates/grid/table.html",'<grid-table>\n    <span ng-repeat="link in links">\n        <a href="javascript:void(0);" ng-click="edit(link)">{{link.title}}</a>\n      </span>\n    <alert ng-repeat="alert in alerts" type="{{alert.type}}" close="closeAlert($index)">{{alert.msg}}</alert>\n\n    <table class="table grid">\n        <thead table-thead table="tableInst"></thead>\n        <tbody>\n            <tr ng-repeat="row in rows">\n                <td ng-repeat="column in columns">\n                    <span ng-if="column.attributeName !== \'links\'">{{row[column.attributeName]}}</span>\n                    <span ng-if="column.attributeName == \'links\'">\n                        <span ng-repeat="link in row.links">\n                            <a href="javascript:void(0);" ng-click="edit(link)">{{link.title}}</a>\n                        </span>\n                    </span>\n                </td>\n            </tr>\n        </tbody>\n    </table>\n    <div table-pagination table="tableInst"></div>\n</grid-table>\n\n<!--<pagination ng-if="rows" direction-links="false" boundary-links="true" items-per-page="itemsPerPage" total-items="totalItems" ng-model="currentPage" ng-change="pageChanged(currentPage)"></pagination>-->')}]),$});